services:
  # Ollama Proxy - bridges host network to honeypot network
  # Uses host network to access Windows Ollama, exposes port 11435 for honeypot
  ollama-proxy:
    image: alpine/socat
    container_name: ollama-proxy
    network_mode: host
    command: TCP-LISTEN:11435,fork,reuseaddr TCP:192.168.13.162:11434
    restart: unless-stopped

  # Main Beelzebub Honeypot with built-in traffic capture
  beelzebub:
    image: m4r10/beelzebub:latest
    container_name: beelzebub-honeypot
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-ollama}
      # Use Docker gateway to reach the host-network proxy
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://172.17.0.1:11435/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-llama3.1:8b}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    ports:
      - "2223:22"    # SSH with Ollama LLM support
      - "8081:80"    # HTTP
      - "8443:443"   # HTTPS
      - "2121:21"    # FTP
      - "2323:23"    # Telnet
      - "3306:3306"  # MySQL
      - "5432:5432"  # PostgreSQL
    volumes:
      - ./beelzebub-example/configurations:/configurations
      - ./logs:/logs
      - ./pcap_captures:/pcap_captures
      - ./capture_traffic.sh:/capture_traffic.sh:ro
    restart: unless-stopped
    networks:
      - honeypot_net
    depends_on:
      - ollama-proxy
    command:
      - /bin/bash
      - -c
      - |
        # Start tcpdump in background to capture ALL traffic on eth0 (172.18.x.x network)
        echo "ðŸ” Starting packet capture on Beelzebub network interface..."
        mkdir -p /pcap_captures
        nohup bash /capture_traffic.sh > /logs/pcap_capture.log 2>&1 &
        
        # Start Beelzebub honeypot
        exec /app/beelzebub

networks:
  honeypot_net:
    driver: bridge
