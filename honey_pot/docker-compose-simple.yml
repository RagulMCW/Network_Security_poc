version: '3.8'

services:
  beelzebub:
    image: m4r10/beelzebub:latest
    container_name: beelzebub-honeypot
    env_file:
      - .env
    environment:
      - GLM_KEY=${GLM_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}
    ports:
      - "2222:22"    # SSH
      - "8080:80"    # HTTP
      - "8443:443"   # HTTPS
      - "2121:21"    # FTP
      - "2323:23"    # Telnet
      - "3306:3306"  # MySQL
      - "5432:5432"  # PostgreSQL
    volumes:
      - ./beelzebub-example/configurations:/configurations
      - ./logs:/logs
    restart: unless-stopped
    networks:
      - honeypot_net

  # Packet capture for honeypot network
  honeypot-capture:
    image: nicolaka/netshoot:latest
    container_name: beelzebub-pcap-capture
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./pcap_captures:/pcap_captures
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: >
      bash -c "
        echo 'Starting Beelzebub honeypot packet capture...';
        sleep 5;
        apk add --no-cache docker-cli;
        PROD_BRIDGE_ID=$$(docker network inspect custom_net -f '{{.Id}}' 2>/dev/null | cut -c1-12);
        BEELZEBUB_IP=$$(docker inspect beelzebub-honeypot --format '{{range \$$net, \$$conf := .NetworkSettings.Networks}}{{if contains \$$net \"honeypot\"}}{{printf \"%s\" \$$conf.IPAddress}}{{end}}{{end}}' 2>/dev/null || echo '172.18.0.2');
        if [ -z \"\$$PROD_BRIDGE_ID\" ]; then
          echo 'ERROR: custom_net network not found';
          exit 1;
        fi;
        PROD_IFACE=\"br-\$$PROD_BRIDGE_ID\";
        echo \"Capturing iptables-redirected traffic on \$$PROD_IFACE (Beelzebub IP: \$$BEELZEBUB_IP)\";
        mkdir -p /pcap_captures;
        tcpdump -i \$$PROD_IFACE -s 0 -G 10 -w /pcap_captures/honeypot_%Y%m%d_%H%M%S.pcap -Z root \"dst \$$BEELZEBUB_IP or src \$$BEELZEBUB_IP\" 2>&1 | tee /pcap_captures/capture.log;
      "
    restart: unless-stopped

networks:
  honeypot_net:
    driver: bridge
