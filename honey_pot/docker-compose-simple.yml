services:
  # Main Beelzebub Honeypot with GLM-4.5 LLM Support
  beelzebub:
    image: m4r10/beelzebub:latest
    container_name: beelzebub-honeypot
    env_file:
      - .env
    environment:
      - GLM_KEY=${GLM_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-https://api.z.ai/api/anthropic}
    ports:
      - "2223:22"    # SSH with GLM-4.5 AI support
      - "8081:80"    # HTTP
      - "8443:443"   # HTTPS
      - "2121:21"    # FTP
      - "2323:23"    # Telnet
      - "3306:3306"  # MySQL
      - "5432:5432"  # PostgreSQL
    volumes:
      - ./beelzebub-example/configurations:/configurations
      - ./logs:/logs
    restart: unless-stopped
    networks:
      - honeypot_net

  # Packet Capture - Captures traffic to/from honeypot
  pcap-capture:
    image: nicolaka/netshoot:latest
    container_name: honeypot-pcap
    network_mode: "service:beelzebub"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./pcap_captures:/pcap_captures
      - ./logs:/logs
    command:
      - /bin/bash
      - -c
      - |
        echo 'ðŸ” Starting packet capture for honeypot traffic...'
        echo 'ðŸ“¦ Capturing TCP traffic on honeypot ports'
        echo 'â™»ï¸ Auto-rotating every 10 seconds, keeping last 5 files'
        mkdir -p /pcap_captures
        while true; do
          timestamp=$$(date +%Y%m%d_%H%M%S)
          echo "[INFO] Starting capture: honeypot_$${timestamp}.pcap"
          timeout 10 tcpdump -i any -s 0 -w /pcap_captures/honeypot_$${timestamp}.pcap -Z root \
            'tcp and (port 22 or port 80 or port 443 or port 3306 or port 5432 or port 21 or port 23)' \
            2>&1 | tee -a /logs/pcap_capture.log
          echo "[INFO] Rotation complete. Cleaning old files..."
          cd /pcap_captures && ls -t honeypot_*.pcap 2>/dev/null | tail -n +6 | xargs -r rm -f
          echo "[INFO] Kept last 5 PCAP files"
          sleep 2
        done
    restart: unless-stopped
    depends_on:
      - beelzebub

networks:
  honeypot_net:
    driver: bridge
