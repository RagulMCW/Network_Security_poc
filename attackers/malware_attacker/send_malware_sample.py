#!/usr/bin/env python3
"""
Send real malware APK file via HTTP POST
Ensures Zeek captures and extracts the complete binary file
"""

import requests
import hashlib
import os
import sys

# Configuration
TARGET_IP = os.getenv('TARGET_IP', '192.168.6.131')
TARGET_PORT = os.getenv('TARGET_PORT', '5000')
FILE_PATH = '/app/sample.apk'

def calculate_hash(filepath):
    """Calculate SHA256 hash of file"""
    sha256 = hashlib.sha256()
    with open(filepath, 'rb') as f:
        for chunk in iter(lambda: f.read(8192), b''):
            sha256.update(chunk)
    return sha256.hexdigest()

def send_file():
    """Send binary file via HTTP POST"""
    
    if not os.path.exists(FILE_PATH):
        print(f"ERROR: File {FILE_PATH} not found!")
        return False
    
    print("=" * 60)
    print("SENDING REAL MALWARE SAMPLE (Binary Transfer)")
    print("=" * 60)
    print(f"File: {FILE_PATH}")
    print(f"Target: http://{TARGET_IP}:{TARGET_PORT}/api/files/upload")
    print()
    
    # Calculate hash
    print("Calculating SHA256 hash...")
    original_hash = calculate_hash(FILE_PATH)
    print(f"✓ Original Hash: {original_hash}")
    
    file_size = os.path.getsize(FILE_PATH)
    print(f"✓ File Size: {file_size:,} bytes ({file_size/1024/1024:.2f} MB)")
    print()
    
import time

def slow_file_generator(filepath, chunk_size=8192, delay=0.0001):
    """Yield file chunks with minimal delay"""
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(chunk_size)
            if not chunk:
                break
            yield chunk
            time.sleep(delay)

def send_file():
    """Send binary file via HTTP POST"""
    
    if not os.path.exists(FILE_PATH):
        print(f"ERROR: File {FILE_PATH} not found!")
        return False
    
    print("=" * 60)
    print("SENDING FIRMWARE UPDATE (Binary Transfer)")
    print("=" * 60)
    print(f"File: {FILE_PATH}")
    print(f"Target: http://{TARGET_IP}:{TARGET_PORT}/api/v1/firmware/update")
    print()
    
    # Calculate hash
    print("Calculating SHA256 hash...")
    original_hash = calculate_hash(FILE_PATH)
    print(f"✓ Original Hash: {original_hash}")
    
    file_size = os.path.getsize(FILE_PATH)
    print(f"✓ File Size: {file_size:,} bytes ({file_size/1024/1024:.2f} MB)")
    print()
    
    # Prepare request
    url = f"http://{TARGET_IP}:{TARGET_PORT}/api/v1/firmware/update"
    headers = {
        'Content-Type': 'application/octet-stream',
        'Content-Disposition': 'attachment; filename=firmware_update.bin',
        'X-Filename': 'firmware_update.bin',
        'X-Original-Hash': original_hash,
        'X-File-Size': str(file_size),
        'User-Agent': 'Mozilla/5.0 (Android 10; Mobile) AppleWebKit/537.36'
    }
    
    print("Starting HTTP POST transfer (Slow Mode)...")
    print("Method: application/octet-stream (raw binary)")
    print("Sending with delay to ensure Zeek capture...")
    print()
    
    try:
        # Send with timeout and generator
        response = requests.post(
            url,
            data=slow_file_generator(FILE_PATH),
            headers=headers,
            timeout=300  # Increased timeout for slow transfer
        )
        
        print("=" * 60)
        print("✓ TRANSFER COMPLETED!")
        print("=" * 60)
        print(f"Status Code: {response.status_code}")
        print(f"Response: {response.text[:200]}")
        print()
        print(f"Expected Hash: {original_hash}")
        print()
        print("Next steps:")
        print("1. Check Zeek extracted files in zeek_logs/<session>/extracted_files/")
        print("2. Calculate hash of extracted file")
        print("3. Verify match:", original_hash)
        print("=" * 60)
        
        return response.status_code == 200
        
    except requests.exceptions.Timeout:
        print("✗ ERROR: Request timed out (120s limit)")
        return False
        
    except requests.exceptions.ConnectionError as e:
        print(f"✗ ERROR: Connection failed - {e}")
        return False
        
    except Exception as e:
        print(f"✗ ERROR: {e}")
        return False

if __name__ == '__main__':
    success = send_file()
    sys.exit(0 if success else 1)
