#!/usr/bin/env python3
"""
Send real  APK file via HTTP POST - SINGLE SHOT TRANSFER
Ensures Zeek captures and extracts the complete binary file in one request
"""

import requests
import hashlib
import os
import sys

# Configuration
TARGET_IP = os.getenv('TARGET_IP', '192.168.6.131')
TARGET_PORT = os.getenv('TARGET_PORT', '5000')
FILE_PATH = '/app/sample.apk'

def calculate_hash(filepath):
    """Calculate SHA256 hash of file"""
    sha256 = hashlib.sha256()
    with open(filepath, 'rb') as f:
        for chunk in iter(lambda: f.read(8192), b''):
            sha256.update(chunk)
    return sha256.hexdigest()

def send_file():
    """Send entire binary file via HTTP POST in a single request"""
    
    if not os.path.exists(FILE_PATH):
        print(f"ERROR: File {FILE_PATH} not found!")
        return False
    
    print("=" * 70)
    print("SENDING  SAMPLE (SINGLE SHOT - FULL FILE TRANSFER)")
    print("=" * 70)
    print(f"File: {FILE_PATH}")
    print(f"Target: http://{TARGET_IP}:{TARGET_PORT}/api/v1/firmware/update")
    print()
    
    # Calculate hash before sending
    print("Calculating SHA256 hash of original file...")
    original_hash = calculate_hash(FILE_PATH)
    print(f"âœ“ Original Hash: {original_hash}")
    
    file_size = os.path.getsize(FILE_PATH)
    print(f"âœ“ File Size: {file_size:,} bytes ({file_size/1024/1024:.2f} MB)")
    print()
    
    # Prepare request with raw binary
    url = f"http://{TARGET_IP}:{TARGET_PORT}/api/v1/firmware/update"
    headers = {
        'Content-Type': 'application/octet-stream',
        'Content-Disposition': 'attachment; filename=_sample.apk',
        'X-Filename': '_sample.apk',
        'X-Original-Hash': original_hash,
        'X-File-Size': str(file_size),
        'User-Agent': 'AndroidUpdater/1.0'
    }
    
    print("Transfer Mode: SINGLE SHOT (entire file at once)")
    print("Method: HTTP POST with application/octet-stream")
    print("Loading entire file into memory...")
    print()
    
    try:
        # Read entire file into memory at once
        with open(FILE_PATH, 'rb') as f:
            file_data = f.read()
        
        print(f"âœ“ Loaded {len(file_data):,} bytes into memory")
        print(f"âœ“ Sending complete file in single HTTP POST request...")
        print()
        
        # Send entire file in one request
        response = requests.post(
            url,
            data=file_data,
            headers=headers,
            timeout=120  # 2 minute timeout for large file
        )
        
        print("=" * 70)
        print("âœ“ TRANSFER COMPLETED!")
        print("=" * 70)
        print(f"HTTP Status: {response.status_code}")
        print(f"Response: {response.text[:200] if response.text else 'No response body'}")
        print()
        print(f"ðŸ“‹ File Information:")
        print(f"   Original Hash: {original_hash}")
        print(f"   File Size:     {file_size:,} bytes")
        print(f"   Transfer Mode: Single shot (no chunking)")
        print()
        print("Next Steps:")
        print("1. Check Zeek extracted files:")
        print("   cd network/zeek_logs/<latest_session>/extracted_files/")
        print()
        print("2. Find the extracted file (should be largest file)")
        print()
        print("3. Calculate hash of extracted file:")
        print(f"   Get-FileHash -Algorithm SHA256 <extracted_file>")
        print()
        print("4. Verify hash matches:")
        print(f"   Expected: {original_hash}")
        print()
        print("5. Check against Bazaar:")
        print(f"   CHECK_HASH.bat {original_hash} --online")
        print("=" * 70)
        
        return response.status_code == 200
        
    except requests.exceptions.Timeout:
        print("=" * 70)
        print("âœ— ERROR: Request timed out (120s)")
        print("=" * 70)
        print("The server did not respond within 2 minutes.")
        print("Check if network monitor container is running.")
        return False
        
    except requests.exceptions.ConnectionError as e:
        print("=" * 70)
        print("âœ— ERROR: Connection failed")
        print("=" * 70)
        print(f"Details: {e}")
        print()
        print("Troubleshooting:")
        print("1. Check if network monitor is running:")
        print("   docker ps --filter name=monitor")
        print()
        print("2. Verify network connectivity:")
        print(f"   docker exec _attacker ping {TARGET_IP}")
        print()
        print("3. Check monitor logs:")
        print("   docker logs network-monitor")
        return False
        
    except Exception as e:
        print("=" * 70)
        print("âœ— ERROR: Unexpected error")
        print("=" * 70)
        print(f"Details: {e}")
        return False

if __name__ == '__main__':
    success = send_file()
    sys.exit(0 if success else 1)
