#!/bin/bash

# Malware File Upload Attacker (Signature-Based Detection - Case 1)
# This attacker focuses ONLY on uploading real malware APK files
# Should be detected by signature-based verification (hash matching)

# Configuration
TARGET_IP="${TARGET_IP:-192.168.6.131}"
TARGET_PORT="${TARGET_PORT:-5000}"
UPLOAD_INTERVAL="${UPLOAD_INTERVAL:-5}"
LOG_FILE="/var/log/malware_simulator.log"

# Ensure log file exists
touch "$LOG_FILE"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

cleanup() {
    log_message "Stopping malware file uploader"
    jobs -p | xargs -r kill 2>/dev/null || true
    exit 0
}

trap cleanup SIGTERM SIGINT

# Main execution
log_message "========================================="
log_message "Malware File Upload Attacker Started"
log_message "Detection Method: SIGNATURE-BASED (Case 1)"
log_message "Container IP: $CONTAINER_IP"
log_message "Target: $TARGET_IP:$TARGET_PORT"
log_message "Upload Interval: ${UPLOAD_INTERVAL}s"
log_message "========================================="

# Main loop - continuous malware file upload
log_message "Starting continuous malware APK upload..."
while true; do
    log_message "[UPLOAD] Sending malware APK file..."
    python3 /app/send_malware_sample.py
    
    # Sleep for configured interval
    sleep "$UPLOAD_INTERVAL"
done
