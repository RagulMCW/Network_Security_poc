# Single Shot Malware Transfer - Setup Complete

## âœ… Configuration Summary

### File Information
- **Location**: `attackers/malware_attacker/sample.apk`
- **SHA256**: `945C9508137E5B5CC9FAEDC2A7C19F938968DE30ADB679BAA7D0B6A13E2B83B3`
- **Size**: 56 bytes
- **Type**: APK (simulated malware)

### Transfer Mode
**SINGLE SHOT TRANSFER** - Entire file sent in one HTTP POST request
- No chunking
- No streaming
- Complete binary loaded into memory and sent at once
- Ensures Zeek captures the complete file with preserved hash

## ğŸš€ How to Use

### Step 1: Rebuild Container
```bash
cd attackers\malware_attacker
REBUILD.bat
```

This will:
- Copy `sample.apk` into the container
- Install dependencies (requests library)
- Configure for single-shot transfer

### Step 2: Verify Container is Running
```bash
docker ps --filter name=malware
```

Expected output:
```
malware_attacker    Up X minutes
```

### Step 3: Send the Malware Sample
```bash
SEND_SAMPLE.bat
```

This will:
1. Load entire APK file into memory (56 bytes)
2. Send via HTTP POST to `192.168.6.131:5000/api/v1/firmware/update`
3. Use `Content-Type: application/octet-stream` (raw binary)
4. Include original hash in `X-Original-Hash` header
5. Complete transfer in single request (no chunking)

### Step 4: Find Extracted File
```powershell
# Navigate to latest Zeek session
cd network\zeek_logs

# List sessions (newest first)
dir /od

# Go to latest session
cd session_YYYYMMDD_HHMMSS\extracted_files

# Find largest file (should be the APK)
dir | sort Length -Descending
```

### Step 5: Verify Hash
```powershell
# Calculate hash of extracted file
Get-FileHash -Algorithm SHA256 .\extract-XXXXXXXXX-HTTP-XXXXXX

# Compare with original
# Expected: 945C9508137E5B5CC9FAEDC2A7C19F938968DE30ADB679BAA7D0B6A13E2B83B3
```

### Step 6: Check Against MalwareBazaar
```bash
cd malware_db
CHECK_HASH.bat 945C9508137E5B5CC9FAEDC2A7C19F938968DE30ADB679BAA7D0B6A13E2B83B3 --online
```

Expected result:
- **Step 1**: Not EICAR (skip)
- **Step 2**: Query MalwareBazaar API
- **Result**: Hash found/not found in database

## ğŸ” Technical Details

### HTTP Request Format
```http
POST /api/v1/firmware/update HTTP/1.1
Host: 192.168.6.131:5000
Content-Type: application/octet-stream
Content-Disposition: attachment; filename=malware_sample.apk
X-Filename: malware_sample.apk
X-Original-Hash: 945C9508137E5B5CC9FAEDC2A7C19F938968DE30ADB679BAA7D0B6A13E2B83B3
X-File-Size: 56
User-Agent: AndroidUpdater/1.0

[BINARY DATA - 56 bytes]
```

### Python Transfer Code
```python
# Load entire file into memory
with open(FILE_PATH, 'rb') as f:
    file_data = f.read()

# Send in single POST request
response = requests.post(
    url,
    data=file_data,  # Complete file, not chunked
    headers=headers,
    timeout=120
)
```

### Why Single Shot?
1. **Hash Preservation**: Complete binary transfer ensures hash integrity
2. **Zeek Compatibility**: Easier for Zeek to extract complete file
3. **No Fragmentation**: Entire file in one network capture
4. **Faster**: No artificial delays or chunking overhead
5. **Verifiable**: Direct hash comparison possible

## ğŸ“Š Expected Workflow

```
Container (malware_attacker)
    â”‚
    â”œâ”€ Load sample.apk (56 bytes)
    â”œâ”€ Calculate SHA256: 945C9508...
    â””â”€ HTTP POST (single request)
         â”‚
         â–¼
Network (custom_net)
    â”‚
    â”œâ”€ Zeek captures packet
    â”œâ”€ Zeek identifies HTTP file transfer
    â””â”€ Zeek extracts file
         â”‚
         â–¼
Extracted File (zeek_logs/session_XXX/extracted_files/)
    â”‚
    â”œâ”€ Name: extract-TIMESTAMP-HTTP-UID
    â”œâ”€ Size: 56 bytes
    â””â”€ SHA256: 945C9508... (must match!)
         â”‚
         â–¼
Hash Verification
    â”‚
    â”œâ”€ Get-FileHash (PowerShell)
    â”œâ”€ Compare with original
    â””â”€ âœ“ Match confirmed
         â”‚
         â–¼
MalwareBazaar Check
    â”‚
    â”œâ”€ CHECK_HASH.bat <hash> --online
    â”œâ”€ Step 1: Check EICAR (skip)
    â”œâ”€ Step 2: Query API
    â””â”€ Result: Malware detected/clean
```

## ğŸ› ï¸ Troubleshooting

### Issue: File not found in container
**Solution**: Run `REBUILD.bat` to copy sample.apk into container

### Issue: Hash mismatch
**Possible causes**:
- File corrupted during transfer
- Zeek extracted wrong file
- Encoding issue

**Solution**: 
- Verify `Content-Type: application/octet-stream` is used
- Check Zeek configuration for file extraction
- Ensure no compression/encoding is applied

### Issue: No file extracted by Zeek
**Solution**:
- Check Zeek is running: `docker logs network-monitor`
- Verify file extraction is enabled in Zeek config
- Check HTTP traffic is on monitored interface

### Issue: Connection refused
**Solution**:
- Verify network monitor container is running
- Check IP address: `192.168.6.131`
- Test connectivity: `docker exec malware_attacker ping 192.168.6.131`

## ğŸ“ Files Modified

1. âœ… `send_malware_sample.py` - Single shot transfer implementation
2. âœ… `Dockerfile` - Copy sample.apk into container
3. âœ… `SEND_SAMPLE.bat` - Updated with new hash
4. âœ… `REBUILD.bat` - New rebuild script
5. âœ… `sample.apk` - Real APK file copied from root directory

## ğŸ¯ Success Criteria

âœ… File transferred in single HTTP POST
âœ… Zeek captures complete transfer
âœ… Extracted file hash matches original: `945C9508137E5B5CC9FAEDC2A7C19F938968DE30ADB679BAA7D0B6A13E2B83B3`
âœ… MalwareBazaar API query returns results (or hash_not_found)
âœ… 2-step detection system works correctly

## ğŸ”— Related Documentation

- **MalwareBazaar API**: `malware_db/MALWAREBAZAAR_API_GUIDE.md`
- **Hash Checking**: `malware_db/README.md`
- **Malware Transfer Guide**: `attackers/malware_attacker/MALWARE_SAMPLE_GUIDE.md`

---

**Status**: âœ… READY TO TEST

Run `REBUILD.bat` followed by `SEND_SAMPLE.bat` to start testing!
