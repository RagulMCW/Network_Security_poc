# EICAR Detection - Complete Flow

## üéØ Overview

Your malware attacker sends EICAR test strings ‚Üí Zeek captures and logs them ‚Üí You can analyze the detections

---

## ‚úÖ YES, Your EICAR Test WILL WORK!

### Current Setup:

**1. Malware Attacker Container** (`malware_attacker/`)
- ‚úÖ Has EICAR string: `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`
- ‚úÖ Sends it via HTTP POST every 40 seconds
- ‚úÖ Wrapped in JSON: `{"content":"EICAR_STRING"...}`
- ‚úÖ Target: `192.168.6.131:5000`
- ‚úÖ **Uses legitimate-looking endpoints** (not obvious "malware" paths)
- ‚úÖ **Realistic User-Agents** (looks like normal browser traffic)

**2. Zeek Monitor** (`network/zeek/`)
- ‚úÖ Captures all Docker network traffic
- ‚úÖ Now has EICAR detection enabled
- ‚úÖ Generates multiple logs showing the attack

---

## üìã What Logs Will Show EICAR

### 1. **http.log** - Shows the HTTP POST
```
ts          id.orig_h      id.resp_h       method  uri                      user_agent
1700000000  192.168.6.X    192.168.6.131   POST    /api/v1/files/upload    Mozilla/5.0 Chrome/120.0.0.0
```

**What you'll see:**
- Source IP: Your malware container
- Destination: 192.168.6.131:5000
- Method: POST
- URI: `/api/v1/files/upload` (looks like normal file upload!)
- User-Agent: "Mozilla/5.0..." (looks like normal browser!)
- **NOTE:** Endpoint looks legitimate - detection must rely on EICAR content!

### 2. **conn.log** - Shows the connection
```
ts          id.orig_h      id.resp_h       service  duration  orig_bytes  resp_bytes
1700000000  192.168.6.X    192.168.6.131   http     0.234     512         156
```

### 3. **files.log** - Shows file transfer detected
```
ts          fuid           tx_hosts       rx_hosts       mime_type        filename
1700000000  FxxxxXXXxxx    192.168.6.X    192.168.6.131  application/json malware_sample_X.exe
```

### 4. **notice.log** - Shows EICAR alert! ‚ö†Ô∏è
```
ts          note                            msg                                      src           dst
1700000000  Signatures::Sensitive_Signature EICAR test string detected in HTTP...   192.168.6.X   192.168.6.131
```

**This is the SMOKING GUN!** - Proves EICAR was detected

### 5. **signatures.log** - Signature matches
```
ts          src_addr       dst_addr       sig_id    event
1700000000  192.168.6.X    192.168.6.131  eicar-*   EICAR string in HTTP POST body
```

---

## üîç How to Verify EICAR Detection

### Step 1: Start Malware Attacker
```bash
cd Network_Security_poc/attackers/malware_attacker
START.bat
```

### Step 2: Start Zeek Monitor
```bash
cd Network_Security_poc/network/zeek
START.bat
```

### Step 3: Wait 40 seconds
The EICAR upload happens every 40 seconds (configurable via `EICAR_INTERVAL`)

### Step 4: Check Zeek Logs
```bash
cd Network_Security_poc/network/zeek_logs
dir /B /S *.log
```

Look in the latest `session_YYYYMMDD_HHMMSS/` folder for:
- ‚úÖ `http.log` - Will have POST to `/api/upload/malware`
- ‚úÖ `notice.log` - Will have EICAR detection alert
- ‚úÖ `signatures.log` - Will show signature match
- ‚úÖ `files.log` - Will show file transfer

---

## üìä Example Detection Output

### In http.log:
```
#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_depth     method  host    uri     user_agent      request_body_len        response_body_len
1732012345.123  CHxxx   192.168.6.15    54321          192.168.6.131   5000           1               POST    192.168.6.131   /api/v1/files/upload     Mozilla/5.0 Chrome/120.0.0.0  250     45
```

### In notice.log:
```
#fields ts      uid     id.orig_h       id.resp_h       note    msg
1732012345.123  CHxxx   192.168.6.15    192.168.6.131   Signatures::Sensitive_Signature EICAR test string detected in HTTP traffic from 192.168.6.15 to 192.168.6.131
```

---

## üîß What's Inside the Packet

When Zeek captures the traffic, the raw packet contains:

```http
POST /api/v1/files/upload HTTP/1.1
Host: 192.168.6.131:5000
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0
Content-Type: application/json
X-Upload-Client: web
Content-Length: 150

{
  "type": "document",
  "filename": "report_1_20251119.pdf",
  "content": "X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*",
  "size": 68
}
```

**KEY POINT:** The endpoint and headers look completely normal - like a regular file upload!
Only the EICAR content in the body reveals it's malicious.

**Zeek sees:**
1. ‚úÖ HTTP POST method (normal)
2. ‚úÖ JSON content-type (normal)
3. ‚úÖ EICAR string in the body ‚ö†Ô∏è **THIS IS THE ONLY INDICATOR!**
4. ‚úÖ Normal-looking user-agent (Mozilla/Chrome)
5. ‚úÖ Normal-looking URI (/api/v1/files/upload)

**Only deep packet inspection catches it!**
This demonstrates why signature-based detection on content is critical.

---

## üéØ Detection Mechanisms

### Mechanism 1: HTTP Body Inspection
```zeek
event http_entity_data(c: connection, is_orig: bool, length: count, data: string)
{
    if ( /X5O!P%@AP\[4\\PZX54\(P\^\)7CC\)7\}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H\+H\*/ in data )
    {
        # ALERT!
    }
}
```

### Mechanism 2: Signature Matching
```sig
signature eicar-http-post {
    ip-proto == tcp
    dst-port == 80, 8080, 5000
    http-request-body /.*EICAR-STANDARD-ANTIVIRUS-TEST-FILE.*/
    event "EICAR string in HTTP POST body"
}
```

### Mechanism 3: File Analysis
```zeek
event file_sniff(f: fa_file, meta: fa_metadata)
{
    # Extracts files from HTTP and scans them
}
```

---

## üö® Expected Alert Timeline

```
Time    Event
00:00   Malware attacker starts
00:00   Zeek monitor starts
00:40   First EICAR upload sent
00:40   Zeek captures packet
00:42   Zeek processes PCAP (2-sec delay)
00:42   http.log created with POST entry
00:42   notice.log created with EICAR alert
00:42   files.log shows file transfer
01:20   Second EICAR upload (40s interval)
02:00   Third EICAR upload
...     Continues every 40 seconds
```

---

## üîç How to Search for EICAR in Logs

### PowerShell Commands:

**Find all EICAR detections:**
```powershell
Get-Content Network_Security_poc\network\zeek_logs\*\notice.log | Select-String "EICAR"
```

**Find all malware uploads:**
```powershell
Get-Content Network_Security_poc\network\zeek_logs\*\http.log | Select-String "files/upload\|storage/sync"
```

**Count EICAR events:**
```powershell
(Get-Content Network_Security_poc\network\zeek_logs\*\notice.log | Select-String "EICAR").Count
```

### Linux/WSL Commands:

```bash
# Find all file uploads (now uses generic endpoints)
grep -r "files/upload" /mnt/e/Malware_detection_using_Aiagent/Network_Security_poc/network/zeek_logs/*/http.log

# Show signature matches
cat /mnt/e/Malware_detection_using_Aiagent/Network_Security_poc/network/zeek_logs/*/signatures.log
```

---

## ‚úÖ Verification Checklist

- [ ] Malware attacker is running (`docker ps` shows container)
- [ ] Zeek monitor is running (window shows "Starting continuous monitoring")
- [ ] Wait at least 40 seconds for first EICAR upload
- [ ] Check zeek_logs folder for new session folders
- [ ] Look for `http.log` with POST to `/api/upload/malware`
- [ ] Look for `notice.log` with EICAR detection
- [ ] Verify source IP matches malware container

---

## üêõ Troubleshooting

### No EICAR detected?

**Check 1:** Is malware attacker sending?
```bash
docker logs malware-attacker | grep EICAR
```
Should see: `[EICAR] Uploaded test file: malware_sample_X.exe`

**Check 2:** Is Zeek capturing?
```bash
wsl ps aux | grep zeek_monitor
```
Should see process running

**Check 3:** Is http.log created?
```bash
dir Network_Security_poc\network\zeek_logs\session_*\http.log
```
Should see files

**Check 4:** Inspect http.log content
```bash
type Network_Security_poc\network\zeek_logs\session_20251119_XXXXXX\http.log
```
Look for POST entries

---

## üéì Understanding the Detection

### Why this works:

1. **Malware attacker** sends EICAR in HTTP POST body
2. **Docker network** routes traffic through `custom_net` bridge
3. **Zeek tcpdump** captures all packets on the bridge
4. **Zeek analyzer** processes PCAP files every 2 seconds
5. **HTTP protocol analyzer** extracts HTTP body content
6. **Signature engine** matches EICAR pattern
7. **Notice framework** generates alert
8. **Logs** written to session folder
9. **Auto-sync** copies to Windows zeek_logs folder

### The EICAR string triggers:
- ‚úÖ HTTP body content inspection
- ‚úÖ Signature pattern matching  
- ‚úÖ File extraction and analysis
- ‚úÖ Notice/alert generation
- ‚úÖ Multiple log entries

---

## üìà What Success Looks Like

After running for 5 minutes, you should see:

```
zeek_logs/
‚îú‚îÄ‚îÄ session_20251119_143000/
‚îÇ   ‚îú‚îÄ‚îÄ conn.log          ‚úÖ Connection records
‚îÇ   ‚îú‚îÄ‚îÄ http.log          ‚úÖ HTTP POST to /api/upload/malware
‚îÇ   ‚îú‚îÄ‚îÄ notice.log        ‚úÖ EICAR detection alert!
‚îÇ   ‚îî‚îÄ‚îÄ signatures.log    ‚úÖ Signature match
‚îú‚îÄ‚îÄ session_20251119_143002/
‚îÇ   ‚îú‚îÄ‚îÄ conn.log          ‚úÖ More connections
‚îÇ   ‚îî‚îÄ‚îÄ http.log          ‚úÖ More HTTP traffic
‚îú‚îÄ‚îÄ session_20251119_143040/
‚îÇ   ‚îú‚îÄ‚îÄ http.log          ‚úÖ Second EICAR upload
‚îÇ   ‚îî‚îÄ‚îÄ notice.log        ‚úÖ Second EICAR alert!
```

**This proves your system works!**

---

## üéØ Summary

| Component | Status | What It Does |
|-----------|--------|--------------|
| **malware_attacker** | ‚úÖ Ready | Sends EICAR every 40s |
| **Zeek monitor** | ‚úÖ Ready | Captures & analyzes traffic |
| **EICAR detection** | ‚úÖ Enabled | Detects EICAR in HTTP |
| **Logging** | ‚úÖ Enabled | http.log, notice.log, files.log |
| **Signatures** | ‚úÖ Loaded | Pattern matching active |

**Your EICAR test WILL work exactly as described!**

Just start both components and check the logs after 40 seconds.
