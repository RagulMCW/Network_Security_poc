# Malware Sample Transfer & Detection Guide

## Overview
This guide explains how to transfer real malware samples (APK files) and detect them using hash comparison with MalwareBazaar database.

## File Information
- **Sample File**: `a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f.apk`
- **SHA256 Hash**: `a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f`
- **Size**: ~5.5 MB
- **Type**: Android APK (malware)

---

## ğŸ¯ Best Method: HTTP Transfer with Zeek Extraction

### Why This Method?
1. **Realistic**: Mimics real-world malware distribution via HTTP
2. **Complete Hash Preservation**: Zeek extracts the exact file with preserved hash
3. **Network Visibility**: Full packet capture for analysis
4. **Multiple Verification Points**:
   - Original file hash
   - Transferred file hash (from Zeek extraction)
   - MalwareBazaar database comparison

---

## ğŸ“‹ Step-by-Step Process

### Step 1: Prepare the Environment

```bash
# Ensure network monitor is running
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\network
.\start_network_monitor.bat

# Ensure malware attacker container is running
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\attackers\malware_attacker
.\START.bat
```

### Step 2: Send the Malware Sample

```bash
# From the malware_attacker directory
.\SEND_SAMPLE.bat
```

**What happens:**
- Container sends APK via HTTP POST to `192.168.6.131:5000/api/v1/files/upload`
- Uses `multipart/form-data` encoding (standard file upload)
- Zeek captures the traffic
- Zeek extracts the file to `zeek_logs/<session>/extracted_files/`

### Step 3: Locate the Extracted File

```bash
# Find the latest Zeek session
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\network\zeek_logs

# List sessions (sorted by time)
dir /od

# Navigate to the latest session
cd session_YYYYMMDD_HHMMSS\extracted_files

# List extracted files
dir
```

**Zeek file naming:**
- Format: `extract-<timestamp>-<protocol>-<conn_uid>`
- Example: `extract-1763552859.388832-HTTP-FxxIXy1KZeRnLcvaO4`

### Step 4: Calculate Hash of Extracted File

**Option A: Using PowerShell**
```powershell
Get-FileHash -Algorithm SHA256 "extract-<filename>" | Format-List
```

**Option B: Using WSL**
```bash
wsl sha256sum "extract-<filename>"
```

**Option C: Using Python**
```bash
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\malware_db
.\CHECK_HASH.bat "path\to\extracted\file"
```

### Step 5: Verify Hash Match

**Expected Result:**
```
SHA256: a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f
```

If the hash matches, the file was transferred successfully without corruption!

### Step 6: Check Against MalwareBazaar

```bash
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\malware_db

# Check by hash
.\CHECK_HASH.bat a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f

# OR check by file
.\CHECK_HASH.bat "E:\Malware_detection_using_Aiagent\Network_Security_poc\network\zeek_logs\session_XXX\extracted_files\extract-XXX"
```

**What to expect:**
- If hash is in MalwareBazaar database â†’ **MALWARE DETECTED**
- Database shows: malware family, signature, threat intel

---

## ğŸ” Alternative Transfer Methods

### Method 1: HTTP Chunked Transfer (Current Implementation)
**Pros:**
- Standard HTTP protocol
- Zeek automatically extracts files
- Hash preserved in transit
- Network visibility

**Cons:**
- Requires running server
- Large file transfer time

### Method 2: Raw Binary Transfer (More Reliable)
Instead of multipart form data, send raw binary:

```bash
# Modify send_sample.sh to use raw binary transfer
curl -v -X POST \
    -H "Content-Type: application/octet-stream" \
    -H "X-Filename: sample.apk" \
    --data-binary "@/app/sample.apk" \
    "http://192.168.6.131:5000/api/v1/files/upload"
```

**Advantages:**
- No encoding overhead
- Smaller transfer size
- Hash definitely preserved

### Method 3: Base64 Encoding (Least Recommended)
```bash
# Encode file to base64
base64 /app/sample.apk > /app/sample.b64

# Send base64
curl -X POST \
    -H "Content-Type: application/json" \
    -d "{\"file\":\"$(cat /app/sample.b64)\",\"filename\":\"sample.apk\"}" \
    "http://192.168.6.131:5000/api/v1/files/upload"
```

**Disadvantages:**
- 33% larger payload
- Must decode on server side
- More complex
- Hash verification requires proper decoding

---

## ğŸ“Š Hash Verification Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Original File                                           â”‚
â”‚ a864d99...40e5f.apk                                    â”‚
â”‚ Hash: a864d99...40e5f                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP POST (multipart/form-data)
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Network Transfer                                        â”‚
â”‚ - Zeek captures packets                                â”‚
â”‚ - Extracts file from HTTP stream                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extracted File                                          â”‚
â”‚ extract-<timestamp>-HTTP-<uid>                         â”‚
â”‚ Hash: ???????                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Calculate SHA256
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hash Comparison                                         â”‚
â”‚ Original:  a864d99...40e5f                             â”‚
â”‚ Extracted: a864d99...40e5f  âœ“ MATCH                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Query MalwareBazaar
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detection Result                                        â”‚
â”‚ âœ“ Hash found in MalwareBazaar                          â”‚
â”‚ âœ“ Malware Family: [...]                                â”‚
â”‚ âœ“ Signature: [...]                                     â”‚
â”‚ âœ“ File Type: Android APK                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ Troubleshooting

### Issue 1: Hash Mismatch
**Cause:** File corruption during transfer or encoding issues

**Solutions:**
1. Use `Content-Type: application/octet-stream` (raw binary)
2. Disable any compression (`Accept-Encoding: identity`)
3. Increase timeout for large files
4. Check Zeek file extraction settings

### Issue 2: File Not Extracted by Zeek
**Cause:** Zeek not configured to extract files from HTTP

**Solution:**
```bash
# Check Zeek configuration
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\network\zeek

# Ensure extract-all-files.zeek is loaded
cat local.zeek
```

Should contain:
```zeek
@load /usr/local/zeek/share/zeek/site/extract-all-files.zeek
```

### Issue 3: Server Not Responding
**Solutions:**
1. Check container status: `docker ps --filter name=monitor`
2. Check container logs: `docker logs network-monitor`
3. Verify network connectivity: `docker exec malware_attacker ping 192.168.6.131`

---

## ğŸ“ˆ Automation Script

Create `verify_transfer.ps1`:

```powershell
# Find latest extracted file
$latestSession = Get-ChildItem "E:\...\network\zeek_logs" | 
    Where-Object { $_.Name -like "session_*" } | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1

$extractedFiles = Get-ChildItem "$($latestSession.FullName)\extracted_files"

foreach ($file in $extractedFiles) {
    $hash = (Get-FileHash -Algorithm SHA256 $file.FullName).Hash
    Write-Host "File: $($file.Name)"
    Write-Host "Hash: $hash"
    
    # Compare with expected hash
    $expectedHash = "a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f"
    
    if ($hash -eq $expectedHash) {
        Write-Host "âœ“ HASH MATCH - File transferred successfully!" -ForegroundColor Green
        
        # Check MalwareBazaar
        & "E:\...\malware_db\CHECK_HASH.bat" $hash
    } else {
        Write-Host "âœ— HASH MISMATCH - Transfer corrupted!" -ForegroundColor Red
    }
}
```

---

## ğŸ“ Summary

### âœ… Recommended Approach

1. **Transfer Method**: HTTP POST with `multipart/form-data` (or `application/octet-stream`)
2. **Capture Tool**: Zeek network monitor
3. **Extraction**: Automatic via Zeek file extraction
4. **Verification**: SHA256 hash comparison
5. **Detection**: MalwareBazaar database lookup

### ğŸ¯ Key Benefits

- **Hash Integrity**: File hash preserved during transfer
- **Network Realism**: Mimics real malware distribution
- **Full Visibility**: Complete packet capture for forensics
- **Automated Detection**: Hash-based malware identification
- **Scalable**: Can handle multiple samples

---

## ğŸ”— Related Files

- Malware Simulator: `malware_simulator.sh`
- Sample Sender: `send_sample.sh`
- Hash Checker: `malware_db/CHECK_HASH.bat`
- Zeek Extractor: `network/zeek/extract-all-files.zeek`

---

## ğŸ“ Next Steps

1. **Run the transfer**: `.\SEND_SAMPLE.bat`
2. **Verify hash**: PowerShell or Python script
3. **Check MalwareBazaar**: `.\CHECK_HASH.bat <hash>`
4. **Analyze results**: Review detection accuracy

The hash-based approach is reliable, industry-standard, and provides verifiable proof of malware detection!
