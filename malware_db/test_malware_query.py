#!/usr/bin/env python3
"""
Test script for malware hash query with MalwareBazaar API
Demonstrates 2-step checking: EICAR first, then MalwareBazaar API
"""

import sys
from pathlib import Path

# Add scripts directory to path
sys.path.insert(0, str(Path(__file__).parent / "scripts"))

from check_hash import MalwareHashChecker


def test_eicar_detection():
    """Test EICAR detection (Step 1)"""
    print("\n" + "="*70)
    print("TEST 1: EICAR Test File Detection")
    print("="*70)
    
    checker = MalwareHashChecker()
    
    # Test EICAR hashes
    test_hashes = {
        "MD5": "44d88612fea8a8f36de82e1278abb02f",
        "SHA1": "3395856ce81f2b7382dee72602f798b642f14140",
        "SHA256": "275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f"
    }
    
    for hash_type, hash_value in test_hashes.items():
        print(f"\nüîç Checking EICAR {hash_type}: {hash_value}")
        matches = checker.check_hash(hash_value)
        
        if matches:
            match = matches[0]
            if match.get("database") == "eicar":
                print(f"‚úÖ PASS: Detected as EICAR ({match.get('signature')})")
                print(f"   Severity: {match.get('severity')}")
            else:
                print(f"‚ùå FAIL: Not detected as EICAR")
        else:
            print(f"‚ùå FAIL: No match found")


def test_malwarebazaar_api():
    """Test MalwareBazaar API query (Step 2)"""
    print("\n" + "="*70)
    print("TEST 2: MalwareBazaar API Query")
    print("="*70)
    
    checker = MalwareHashChecker()
    
    # Known malware hash (example from MalwareBazaar docs)
    test_hash = "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d"
    
    print(f"\nüîç Querying MalwareBazaar API for: {test_hash}")
    print(f"‚è≥ Please wait... (querying online API)")
    
    online_result = checker._check_online(test_hash, hash_type="sha256")
    
    if online_result:
        print(f"\nüì° API Response:")
        print(f"   Source: {online_result.get('source')}")
        print(f"   Query Status: {online_result.get('query_status')}")
        
        if online_result.get('found'):
            print(f"‚úÖ PASS: Hash found in MalwareBazaar")
            print(f"\nüìã Malware Details:")
            print(f"   Signature: {online_result.get('signature')}")
            print(f"   File Type: {online_result.get('file_type')}")
            print(f"   Tags: {online_result.get('tags')}")
            print(f"   First Seen: {online_result.get('first_seen')}")
            print(f"   Reporter: {online_result.get('reporter')}")
        elif online_result.get('error'):
            print(f"‚ö†Ô∏è WARNING: API error - {online_result.get('error')}")
        else:
            print(f"‚ÑπÔ∏è INFO: Hash not found in MalwareBazaar database")
            print(f"   (This could mean it's clean or newly discovered)")
    else:
        print(f"‚ùå FAIL: No response from API")


def test_clean_hash():
    """Test clean hash (not found anywhere)"""
    print("\n" + "="*70)
    print("TEST 3: Clean Hash (Not Found)")
    print("="*70)
    
    checker = MalwareHashChecker()
    
    # Fake hash (all zeros)
    test_hash = "0000000000000000000000000000000000000000000000000000000000000000"
    
    print(f"\nüîç Checking clean hash: {test_hash}")
    
    # Check local databases
    matches = checker.check_hash(test_hash)
    
    if not matches:
        print(f"‚úÖ PASS: Not found in local databases (as expected)")
    else:
        print(f"‚ùå FAIL: Unexpected match in local databases")
    
    # Check online
    print(f"\nüîç Checking online API...")
    online_result = checker._check_online(test_hash, hash_type="sha256")
    
    if online_result:
        if not online_result.get('found'):
            print(f"‚úÖ PASS: Not found in MalwareBazaar (as expected)")
            print(f"   Query Status: {online_result.get('query_status')}")
        else:
            print(f"‚ùå FAIL: Unexpected match in online database")


def test_two_step_workflow():
    """Test the complete 2-step workflow"""
    print("\n" + "="*70)
    print("TEST 4: Complete 2-Step Workflow")
    print("="*70)
    
    checker = MalwareHashChecker()
    
    # Test with EICAR file
    eicar_path = Path(__file__).parent / "test_eicar.txt"
    
    if eicar_path.exists():
        print(f"\nüîç Checking file: {eicar_path}")
        print(f"   Expected: EICAR detected at Step 1 (no API call needed)")
        
        result = checker.check_file(str(eicar_path), check_online=False)
        
        if result.get("threat_level") == "TEST_FILE":
            print(f"‚úÖ PASS: EICAR detected at Step 1")
            print(f"   Check Stage: {result.get('check_stage')}")
            print(f"   Threat Score: {result.get('threat_score')}/100")
            
            if "online_check" not in result:
                print(f"‚úÖ PASS: No API call made (Step 1 returned immediately)")
            else:
                print(f"‚ùå FAIL: API was called unnecessarily")
        else:
            print(f"‚ùå FAIL: EICAR not detected properly")
            print(f"   Threat Level: {result.get('threat_level')}")
    else:
        print(f"‚ö†Ô∏è SKIP: test_eicar.txt not found")


def main():
    """Run all tests"""
    print("\n" + "="*70)
    print("MALWARE HASH QUERY TEST SUITE")
    print("="*70)
    print("\nTesting 2-step malware detection:")
    print("  Step 1: Check EICAR test file (immediate return)")
    print("  Step 2: Query MalwareBazaar API with authentication")
    print("\nAPI Key: f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff")
    
    # Run tests
    test_eicar_detection()
    test_malwarebazaar_api()
    test_clean_hash()
    test_two_step_workflow()
    
    # Summary
    print("\n" + "="*70)
    print("TEST SUITE COMPLETED")
    print("="*70)
    print("\nüìä Summary:")
    print("  ‚úì Step 1 (EICAR detection) - Tested")
    print("  ‚úì Step 2 (MalwareBazaar API) - Tested")
    print("  ‚úì 2-step workflow optimization - Tested")
    print("\nüí° Next Steps:")
    print("  1. Run individual hash checks: python scripts/check_hash.py <hash> --online")
    print("  2. Check files: python scripts/check_hash.py <file_path> --online")
    print("  3. View statistics: python scripts/check_hash.py --stats")
    print()


if __name__ == "__main__":
    main()
