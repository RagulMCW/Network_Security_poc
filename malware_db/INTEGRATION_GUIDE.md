# Malware Detection Integration Guide

Complete guide for using the malware hash database with your Zeek network monitoring system.

## üöÄ Quick Start

### 1. Initial Setup
```bash
cd Network_Security_poc/malware_db
SETUP.bat
```

This will:
- ‚úÖ Install Python dependencies (requests, pyyaml, tqdm)
- ‚úÖ Download 1000+ malware hashes from MalwareBazaar
- ‚úÖ Download YARA detection rules from GitHub
- ‚úÖ Initialize EICAR test signatures

### 2. Verify Installation
```bash
CHECK_HASH.bat --stats
```

Expected output:
```
üìä Malware Database Statistics
============================================================

malwarebazaar:
  md5_count: 1,000
  sha1_count: 1,000
  sha256_count: 1,000

eicar:
  md5_count: 1
  sha1_count: 1
  sha256_count: 1

custom:
  md5_count: 1
  sha1_count: 1
  sha256_count: 1
```

## üìñ Usage Guide

### Standalone Hash Checking

#### Check a File
```bash
CHECK_HASH.bat "C:\path\to\suspicious_file.exe"
```

#### Check a Hash Value
```bash
CHECK_HASH.bat 44d88612fea8a8f36de82e1278abb02f
```

#### Check with Online API
```bash
cd malware_db/scripts
python check_hash.py suspicious_file.exe --online
```

### Integration with MCP Server

The MCP server includes two new tools for malware detection:

#### 1. `check_malware_hash` - Hash-based Detection

**When to use:**
- LLM detects suspicious file in Zeek logs
- Zeek extracts files from network traffic
- HTTP downloads, email attachments, file transfers

**Example LLM workflow:**
```
User: "Analyze the latest Zeek session for malware"

LLM thinks:
1. Call read_zeek_logs() to get traffic data
2. Notice files.log shows extracted file: extract-12345-HTTP-F0bSIo.exe
3. File path: network/zeek_logs/session_20251119/extracted_files/extract-12345-HTTP-F0bSIo.exe
4. Call check_malware_hash(file_path, check_online=False)
5. Result: MALWARE detected! Emotet trojan
6. Call move_device_to_honeypot(source_ip, reason="Emotet malware download")
```

**Tool signature:**
```python
check_malware_hash(
    file_path: str,           # Path to extracted file
    check_online: bool = False  # Query online APIs
) -> str
```

**Returns:**
```
üîç MALWARE HASH CHECK RESULTS
================================================================
üìÑ File: network/zeek_logs/.../extract-12345.exe
üìä Size: 45678 bytes

üîë File Hashes:
  MD5: a1b2c3d4e5f6...
  SHA1: f6e5d4c3b2a1...
  SHA256: 12345abcdef...

üéØ Database Matches: 1

‚ö†Ô∏è THREAT DETECTED!

Match #1:
  Database: malwarebazaar
  Hash Type: SHA256
  Malware Family: Emotet
  Tags: trojan,banking,spam
  File Type: exe
  First Seen: 2025-11-15

üéöÔ∏è Threat Assessment:
  Threat Level: MALWARE
  Threat Score: 100/100

üí° Recommended Action:
  üö® QUARANTINE IMMEDIATELY - Known malware detected!
  üîí Isolate source device to honeypot network
  üìù Log incident for forensic analysis
```

#### 2. `scan_with_yara` - Content-based Detection

**When to use:**
- Hash check returns CLEAN but file is suspicious
- Need to detect polymorphic malware (changes hash)
- Analyze obfuscated scripts, web shells, exploits

**Example LLM workflow:**
```
LLM thinks:
1. check_malware_hash returned CLEAN
2. But file has suspicious HTTP patterns (base64, eval, etc.)
3. Call scan_with_yara(file_path, rule_name="suspicious_http")
4. YARA detects: Suspicious_HTTP_Payload rule triggered
5. Recommend: Further investigation needed
```

**Tool signature:**
```python
scan_with_yara(
    file_path: str,              # Path to file
    rule_name: str = "all"       # "all", "eicar", "suspicious_http", or custom
) -> str
```

**Returns:**
```
üìú YARA SCAN RESULTS
================================================================
üìÑ File: network/zeek_logs/.../extracted_script.php
üéØ Rules: all

üîç Matches Found: 2

‚ö†Ô∏è YARA RULES TRIGGERED!

Match #1: Suspicious_HTTP_Payload
  Metadata:
    description: Detects suspicious HTTP payloads
    severity: medium
  Matched Strings:
    $cmd2: powershell
    $suspicious2: eval(

Match #2: PHP_Webshell
  Metadata:
    description: Detects PHP web shells
    severity: high
  Matched Strings:
    $shell1: system($_GET['cmd'])
```

## üîÑ Automatic Updates

### Daily Updates (Recommended)

#### Windows Task Scheduler
```bash
# Create scheduled task for daily updates at 2 AM
schtasks /create /tn "Update Malware DB" /tr "E:\Malware_detection_using_Aiagent\Network_Security_poc\malware_db\UPDATE_MALWAREBAZAAR.bat" /sc daily /st 02:00

schtasks /create /tn "Update YARA Rules" /tr "E:\Malware_detection_using_Aiagent\Network_Security_poc\malware_db\UPDATE_YARA_RULES.bat" /sc weekly /d SUN /st 03:00
```

### Manual Updates
```bash
# Update MalwareBazaar hashes
UPDATE_MALWAREBAZAAR.bat

# Update YARA rules
UPDATE_YARA_RULES.bat
```

### Python Script Updates
```bash
cd malware_db/scripts

# Download 5000 recent samples
python update_malwarebazaar.py --limit 5000

# Query specific hash
python update_malwarebazaar.py --query a1b2c3d4e5f6...

# Update YARA rules
python update_yara_rules.py
```

## üóÑÔ∏è Database Sources

### Active Sources

| Database | Type | Update Frequency | Coverage | API |
|----------|------|-----------------|----------|-----|
| **MalwareBazaar** | Hashes | Daily | 1M+ samples | ‚úÖ Free |
| **YARA Rules** | Content | Weekly | 1000+ rules | ‚úÖ GitHub |
| **EICAR** | Test | Static | Test files | ‚ùå N/A |
| **Custom** | Hashes | Manual | User-defined | ‚ùå N/A |

### Optional Sources (Manual Integration)

1. **VirusShare** (https://virusshare.com/)
   - 48M+ malware hashes
   - Requires registration
   - Download hash lists manually

2. **Team Cymru MHR** (DNS-based)
   - Query: `<sha1>.malware.hash.cymru.com`
   - Free, no API key needed
   - Already integrated in `check_hash.py --online`

3. **Vx-Underground** (https://vx-underground.org/)
   - APT reports and samples
   - Manual download

## üß™ Testing the Integration

### Test 1: EICAR Detection
```bash
# Create EICAR test file
echo X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H* > eicar.txt

# Check hash
CHECK_HASH.bat eicar.txt
```

Expected result:
```
Threat Level: TEST_FILE
Threat Score: 10/100
```

### Test 2: Real Malware Detection with Zeek

1. **Start Zeek monitor:**
   ```bash
   cd network/zeek
   START.bat
   ```

2. **Simulate malware download:**
   ```bash
   cd attackers/malware_attacker
   START.bat
   ```

3. **Analyze with LLM:**
   ```
   User: "Check for malware in latest Zeek session"
   
   LLM workflow:
   1. read_zeek_logs() - finds extracted files
   2. check_malware_hash(extracted_file) - detects EICAR
   3. move_device_to_honeypot(malware_attacker) - quarantine
   ```

### Test 3: YARA Scanning
```bash
cd malware_db/scripts

# Scan EICAR with YARA
python -c "
import yara
rules = yara.compile(filepath='../yara_rules/custom/eicar.yar')
matches = rules.match('eicar.txt')
print(matches)
"
```

## üîß Troubleshooting

### Issue: "yara-python not installed"

**Solution:**
```bash
# Windows
pip install yara-python

# If build fails, download pre-compiled wheel:
# https://github.com/VirusTotal/yara-python/releases
```

### Issue: "MalwareBazaar API rate limit"

**Symptom:** HTTP 429 error when updating

**Solution:**
- Free API: 200 requests/day
- Update once daily (not hourly)
- Use `--limit 1000` (default) instead of higher values

### Issue: "Hash not found in database"

**Reason:** Unknown/new malware not in public databases

**Solution:**
1. Try online check: `python check_hash.py file.exe --online`
2. Use YARA scanning: `scan_with_yara(file_path, "all")`
3. Add to custom database if confirmed malware

### Issue: "YARA compilation errors"

**Symptom:** Rules fail to compile

**Solution:**
```bash
# Update YARA rules
UPDATE_YARA_RULES.bat

# Use specific rule instead of "all"
scan_with_yara(file_path, rule_name="eicar")
```

## üìä Performance Optimization

### Hash Lookup Performance
- **In-memory hash set**: <1ms per lookup
- **Database size**: 1000 hashes = ~50KB RAM
- **Recommendation**: Keep database <10,000 entries for instant lookups

### YARA Scan Performance
- **Small files (<1MB)**: 10-50ms
- **Large files (>10MB)**: 100-500ms
- **Compiled rules**: 2-3x faster than source rules

### Optimization Tips
```python
# Load databases once at server startup (already implemented)
checker = MalwareHashChecker()  # Loads all DBs into memory

# Compile YARA rules (faster loading)
cd malware_db/scripts
python update_yara_rules.py  # Automatically compiles

# Use compiled rules
rules = yara.load("yara_rules/compiled_rules.yarc")  # Fast!
```

## üîê Security Best Practices

1. **Offline-First Detection**
   - Primary checks use local databases (fast, private)
   - No data leakage to external APIs
   - Works without internet

2. **Online Checks (Optional)**
   - Only for unknown hashes
   - Rate-limited to prevent abuse
   - Never send file contents, only hashes

3. **Quarantine Workflow**
   ```
   Suspicious File Detected
   ‚Üì
   Hash Check (offline) ‚Üí MALWARE
   ‚Üì
   Identify Source Device (Zeek logs)
   ‚Üì
   move_device_to_honeypot(device_id)
   ‚Üì
   Log Incident + Forensic Analysis
   ```

4. **Database Updates**
   - Verify sources (use official repositories)
   - Review custom rules before adding
   - Keep update logs for auditing

## üìù Adding Custom Signatures

### Add Custom Malware Hash
```bash
# Edit: malware_db/hash_databases/custom_malware.txt
SHA256:abc123...|Custom Ransomware|CRITICAL
MD5:def456...|Suspicious Script|MEDIUM
```

### Create Custom YARA Rule
```bash
# Create: malware_db/yara_rules/custom/my_rule.yar
rule Custom_Malware_Detector {
    meta:
        description = "Detects custom malware family"
        author = "Your Name"
        severity = "high"
    
    strings:
        $pattern1 = "malicious_string"
        $pattern2 = { 4D 5A 90 00 }  // Hex pattern
    
    condition:
        $pattern1 or $pattern2
}
```

### Use Custom Rule
```python
# In LLM workflow
scan_with_yara(file_path, rule_name="my_rule")
```

## üìà Monitoring & Metrics

### Database Statistics
```bash
CHECK_HASH.bat --stats
```

### Check Coverage
```python
# How many files scanned today?
# Check: malware_db/logs/scan_history.log

# Most detected malware families?
# Parse: malware_db/hash_databases/malwarebazaar.json
```

## üéØ Best Practices for LLM Integration

### Decision Tree for LLM

```
File Extracted from Zeek
    ‚Üì
1. check_malware_hash(file_path, check_online=False)
    ‚Üì
   Match Found? ‚Üí YES ‚Üí MALWARE
    ‚Üì NO
2. Suspicious Patterns (HTTP, scripts, obfuscation)?
    ‚Üì YES
3. scan_with_yara(file_path, rule_name="all")
    ‚Üì
   Match Found? ‚Üí YES ‚Üí SUSPICIOUS
    ‚Üì NO
4. File appears CLEAN
    ‚Üì
   Log for manual review (optional)
```

### Example LLM Prompt Integration

```python
# In MCP server instructions (already added):

"""
When you detect a suspicious file in Zeek logs:

1. Read files.log to find extracted files
2. Get full path: network/zeek_logs/session_*/extracted_files/extract-*
3. Call check_malware_hash(file_path)
4. If CLEAN but suspicious patterns:
   - Call scan_with_yara(file_path, "suspicious_http")
5. If MALWARE or YARA match:
   - Identify source IP from conn.log
   - Call move_device_to_honeypot(source_device, reason)
   - Report findings to user
"""
```

## üîó API Reference

### MalwareBazaar API
```python
import requests

url = "https://mb-api.abuse.ch/api/v1/"
data = {"query": "get_info", "hash": "sha256_hash"}
response = requests.post(url, data=data)
print(response.json())
```

### Team Cymru MHR (DNS)
```bash
# Query via DNS
nslookup <sha1_hash>.malware.hash.cymru.com

# Returns: last_seen AV_detection_rate
```

## üìö Additional Resources

- **MalwareBazaar**: https://bazaar.abuse.ch/
- **YARA Documentation**: https://yara.readthedocs.io/
- **YARA Rules Repository**: https://github.com/Yara-Rules/rules
- **VirusShare**: https://virusshare.com/
- **Team Cymru MHR**: https://www.team-cymru.com/mhr
- **EICAR Test Files**: https://www.eicar.org/

## ‚ùì FAQ

**Q: How often should I update databases?**
A: MalwareBazaar daily, YARA rules weekly.

**Q: Can I use this offline?**
A: Yes! All checks work offline with local databases.

**Q: What's the difference between hash and YARA scanning?**
A: Hash = fast, exact match. YARA = slower, pattern-based, catches variants.

**Q: How to handle false positives?**
A: Review YARA rule, add to whitelist, or disable specific rule.

**Q: API key required?**
A: No! MalwareBazaar and Team Cymru are free without keys.
