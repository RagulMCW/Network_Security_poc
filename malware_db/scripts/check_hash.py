#!/usr/bin/env python3
"""
Malware Hash Checker

Standalone tool to check file hashes against malware databases.
Can be used independently or called by MCP server.
"""

import hashlib
import json
from pathlib import Path
from datetime import datetime


class MalwareHashChecker:
    
    def __init__(self, db_dir=None):
        if db_dir:
            self.db_dir = Path(db_dir)
        else:
            self.db_dir = Path(__file__).parent.parent / "hash_databases"
        
        self.databases = {
            "malwarebazaar": self.db_dir / "malwarebazaar.txt",
            "custom": self.db_dir / "custom_malware.txt",
            "eicar": self.db_dir / "eicar_test.txt"
        }
        
        # Load databases into memory
        self.hash_sets = {}
        self.hash_metadata = {}
        self._load_databases()
    
    def _load_databases(self):
        """Load all hash databases into memory"""
        for db_name, db_path in self.databases.items():
            if not db_path.exists():
                continue
            
            self.hash_sets[db_name] = {
                "md5": set(),
                "sha1": set(),
                "sha256": set()
            }
            
            with open(db_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    
                    # Skip comments and empty lines
                    if not line or line.startswith('#'):
                        continue
                    
                    parts = line.split('|')
                    
                    if db_name == "malwarebazaar":
                        # Format: SHA256|MD5|SHA1|Signature|Tags|FileType|FirstSeen
                        if len(parts) >= 3:
                            sha256 = parts[0].lower()
                            md5 = parts[1].lower()
                            sha1 = parts[2].lower()
                            
                            self.hash_sets[db_name]["sha256"].add(sha256)
                            self.hash_sets[db_name]["md5"].add(md5)
                            self.hash_sets[db_name]["sha1"].add(sha1)
                            
                            # Store metadata
                            metadata = {
                                "database": db_name,
                                "signature": parts[3] if len(parts) > 3 else "unknown",
                                "tags": parts[4] if len(parts) > 4 else "",
                                "file_type": parts[5] if len(parts) > 5 else "",
                                "first_seen": parts[6] if len(parts) > 6 else ""
                            }
                            
                            self.hash_metadata[sha256] = metadata
                            self.hash_metadata[md5] = metadata
                            self.hash_metadata[sha1] = metadata
                    
                    elif db_name == "eicar":
                        # Format: MD5:hash or SHA1:hash or SHA256:hash
                        if ':' in line:
                            hash_type, hash_value = line.split(':', 1)
                            hash_type = hash_type.lower()
                            hash_value = hash_value.lower()
                            
                            if hash_type in self.hash_sets[db_name]:
                                self.hash_sets[db_name][hash_type].add(hash_value)
                                self.hash_metadata[hash_value] = {
                                    "database": db_name,
                                    "signature": "EICAR Test File",
                                    "severity": "LOW"
                                }
                        else:
                            # Assume MD5 by default
                            hash_value = line.lower()
                            self.hash_sets[db_name]["md5"].add(hash_value)
                            self.hash_metadata[hash_value] = {
                                "database": db_name,
                                "signature": "EICAR Test File",
                                "severity": "LOW"
                            }
                    
                    elif db_name == "custom":
                        # Format: HASH_TYPE:HASH_VALUE|DESCRIPTION|SEVERITY
                        if ':' in parts[0]:
                            hash_type, hash_value = parts[0].split(':', 1)
                            hash_type = hash_type.lower()
                            hash_value = hash_value.lower()
                            
                            if hash_type in self.hash_sets[db_name]:
                                self.hash_sets[db_name][hash_type].add(hash_value)
                                
                                metadata = {
                                    "database": db_name,
                                    "description": parts[1] if len(parts) > 1 else "Unknown",
                                    "severity": parts[2] if len(parts) > 2 else "MEDIUM"
                                }
                                self.hash_metadata[hash_value] = metadata
    
    def compute_hashes(self, file_path):
        """Compute MD5, SHA1, SHA256 for a file"""
        try:
            md5_hash = hashlib.md5()
            sha1_hash = hashlib.sha1()
            sha256_hash = hashlib.sha256()
            
            with open(file_path, 'rb') as f:
                # Read file in chunks
                while chunk := f.read(8192):
                    md5_hash.update(chunk)
                    sha1_hash.update(chunk)
                    sha256_hash.update(chunk)
            
            return {
                "md5": md5_hash.hexdigest(),
                "sha1": sha1_hash.hexdigest(),
                "sha256": sha256_hash.hexdigest()
            }
        except Exception as e:
            return {"error": str(e)}
    
    def check_hash(self, file_hash):
        """Check if a hash exists in any database"""
        file_hash = file_hash.lower()
        matches = []
        
        for db_name, hash_types in self.hash_sets.items():
            for hash_type, hash_set in hash_types.items():
                if file_hash in hash_set:
                    metadata = self.hash_metadata.get(file_hash, {})
                    matches.append({
                        "database": db_name,
                        "hash_type": hash_type,
                        "hash_value": file_hash,
                        **metadata
                    })
        
        return matches
    
    def check_file(self, file_path, check_online=False):
        """Check file hashes against databases"""
        file_path = Path(file_path)
        
        if not file_path.exists():
            return {
                "status": "error",
                "message": f"File not found: {file_path}"
            }
        
        # Compute hashes
        hashes = self.compute_hashes(file_path)
        
        if "error" in hashes:
            return {
                "status": "error",
                "message": hashes["error"]
            }
        
        # Check all hashes
        all_matches = []
        
        for hash_type, hash_value in hashes.items():
            matches = self.check_hash(hash_value)
            all_matches.extend(matches)
        
        # Determine threat level
        threat_score = 0
        threat_level = "CLEAN"
        
        if all_matches:
            # Check for EICAR (low severity test file)
            is_eicar = any(m.get("database") == "eicar" for m in all_matches)
            
            if is_eicar:
                threat_score = 10
                threat_level = "TEST_FILE"
            else:
                threat_score = 100
                threat_level = "MALWARE"
        
        result = {
            "status": "success",
            "file_path": str(file_path),
            "file_size": file_path.stat().st_size,
            "hashes": hashes,
            "matches": all_matches,
            "threat_score": threat_score,
            "threat_level": threat_level,
            "timestamp": datetime.now().isoformat()
        }
        
        # Online check (optional)
        if check_online and not all_matches:
            online_results = self._check_online(hashes["sha256"])
            if online_results:
                result["online_check"] = online_results
        
        return result
    
    def _check_online(self, sha256_hash):
        """Check hash against online APIs (MalwareBazaar, Team Cymru)"""
        try:
            import requests
            
            # MalwareBazaar API
            url = "https://mb-api.abuse.ch/api/v1/"
            data = {"query": "get_info", "hash": sha256_hash}
            
            response = requests.post(url, data=data, timeout=10)
            result = response.json()
            
            if result.get("query_status") == "ok":
                return {
                    "source": "MalwareBazaar",
                    "found": True,
                    "data": result.get("data", [])
                }
            else:
                return {
                    "source": "MalwareBazaar",
                    "found": False
                }
        except Exception as e:
            return {
                "source": "Online Check",
                "error": str(e)
            }
    
    def get_statistics(self):
        """Get database statistics"""
        stats = {}
        
        for db_name, hash_types in self.hash_sets.items():
            stats[db_name] = {
                "md5_count": len(hash_types["md5"]),
                "sha1_count": len(hash_types["sha1"]),
                "sha256_count": len(hash_types["sha256"])
            }
        
        return stats


def main():
    import argparse
    
    parser = argparse.ArgumentParser(description="Check file hash against malware databases")
    parser.add_argument("input", help="File path or hash value to check")
    parser.add_argument("--online", action="store_true", help="Check online APIs")
    parser.add_argument("--stats", action="store_true", help="Show database statistics")
    parser.add_argument("--json", action="store_true", help="Output as JSON")
    
    args = parser.parse_args()
    
    checker = MalwareHashChecker()
    
    if args.stats:
        stats = checker.get_statistics()
        if args.json:
            print(json.dumps(stats, indent=2))
        else:
            print("üìä Malware Database Statistics")
            print("="*60)
            for db_name, counts in stats.items():
                print(f"\n{db_name}:")
                for hash_type, count in counts.items():
                    print(f"  {hash_type}: {count:,}")
        return
    
    # Check if input is a file or hash
    input_path = Path(args.input)
    
    if input_path.exists() and input_path.is_file():
        # Check file
        result = checker.check_file(input_path, check_online=args.online)
    else:
        # Check hash
        matches = checker.check_hash(args.input)
        result = {
            "status": "success",
            "hash": args.input,
            "matches": matches,
            "threat_level": "MALWARE" if matches else "CLEAN"
        }
    
    # Output
    if args.json:
        print(json.dumps(result, indent=2))
    else:
        print("\n" + "="*70)
        print("üîç Malware Hash Check Results")
        print("="*70)
        
        if result.get("status") == "error":
            print(f"\n‚ùå Error: {result['message']}")
        else:
            print(f"\nFile: {result.get('file_path', args.input)}")
            
            if "hashes" in result:
                print(f"\nHashes:")
                for hash_type, hash_value in result["hashes"].items():
                    print(f"  {hash_type.upper()}: {hash_value}")
            
            matches = result.get("matches", [])
            print(f"\nMatches: {len(matches)}")
            
            if matches:
                print("\n‚ö†Ô∏è THREAT DETECTED!")
                for match in matches:
                    print(f"\n  Database: {match.get('database', 'Unknown')}")
                    print(f"  Hash Type: {match.get('hash_type', 'Unknown')}")
                    print(f"  Signature: {match.get('signature', 'Unknown')}")
                    if 'tags' in match:
                        print(f"  Tags: {match['tags']}")
            else:
                print("\n‚úÖ No matches found in local databases")
            
            print(f"\nThreat Level: {result.get('threat_level', 'UNKNOWN')}")
            print(f"Threat Score: {result.get('threat_score', 0)}/100")
        
        print("="*70 + "\n")


if __name__ == "__main__":
    main()
