#!/usr/bin/env python3
"""
MalwareBazaar Hash Database Updater

Downloads latest malware hashes from MalwareBazaar (abuse.ch)
and updates local database for offline hash checking.

API Documentation: https://bazaar.abuse.ch/api/
"""

import requests
import json
import csv
from pathlib import Path
from datetime import datetime
import time


class MalwareBazaarUpdater:
    
    def __init__(self):
        self.api_url = "https://mb-api.abuse.ch/api/v1/"
        self.db_dir = Path(__file__).parent.parent / "hash_databases"
        self.db_file = self.db_dir / "malwarebazaar.txt"
        self.json_file = self.db_dir / "malwarebazaar.json"
        self.headers = {
            'User-Agent': 'MalwareDetectionAgent/1.0'
        }
        
    def download_recent_samples(self, limit=100):
        """Download recent malware samples from MalwareBazaar"""
        print(f"ğŸ”„ Downloading recent samples from MalwareBazaar...")
        
        try:
            # Query for recent samples
            # Selector can be '100' or 'time'
            data = {
                "query": "get_recent",
                "selector": "100"
            }
            
            response = requests.post(self.api_url, data=data, headers=self.headers, timeout=30)
            response.raise_for_status()
            
            result = response.json()
            
            if result.get("query_status") != "ok":
                print(f"âŒ API Error: {result.get('query_status')}")
                return []
            
            samples = result.get("data", [])
            print(f"âœ… Downloaded {len(samples)} samples")
            
            return samples
            
        except requests.exceptions.RequestException as e:
            print(f"âŒ Network error: {str(e)}")
            return []
        except Exception as e:
            print(f"âŒ Error: {str(e)}")
            return []
    
    def query_hash(self, file_hash):
        """Query specific hash from MalwareBazaar"""
        try:
            data = {
                "query": "get_info",
                "hash": file_hash
            }
            
            response = requests.post(self.api_url, data=data, timeout=10)
            response.raise_for_status()
            
            result = response.json()
            
            if result.get("query_status") == "ok":
                return result.get("data", [])
            else:
                return None
                
        except Exception as e:
            print(f"âš ï¸ Query error for {file_hash}: {str(e)}")
            return None
    
    def update_database(self, samples):
        """Update local hash database"""
        print(f"\nğŸ“ Updating local database...")
        
        self.db_dir.mkdir(parents=True, exist_ok=True)
        
        # Read existing hashes
        existing_hashes = set()
        if self.db_file.exists():
            with open(self.db_file, 'r', encoding='utf-8') as f:
                for line in f:
                    if line.strip() and not line.startswith('#'):
                        parts = line.strip().split('|')
                        if len(parts) > 0:
                            existing_hashes.add(parts[0])
        
        print(f"ğŸ“Š Existing database: {len(existing_hashes)} hashes")
        
        # Prepare new entries
        new_entries = []
        for sample in samples:
            sha256 = sample.get("sha256_hash", "")
            md5 = sample.get("md5_hash", "")
            sha1 = sample.get("sha1_hash", "")
            
            if not sha256:
                continue
            
            if sha256 in existing_hashes:
                continue
            
            # Extract metadata
            signature = sample.get("signature", "unknown")
            tags = ",".join(sample.get("tags", []))
            file_type = sample.get("file_type", "")
            first_seen = sample.get("first_seen", "")
            
            # Format: SHA256|MD5|SHA1|Signature|Tags|FileType|FirstSeen
            entry = f"{sha256}|{md5}|{sha1}|{signature}|{tags}|{file_type}|{first_seen}"
            new_entries.append(entry)
            existing_hashes.add(sha256)
        
        if not new_entries:
            print("â„¹ï¸ No new hashes to add")
            return
        
        # Append new entries
        with open(self.db_file, 'a', encoding='utf-8') as f:
            for entry in new_entries:
                f.write(entry + '\n')
        
        print(f"âœ… Added {len(new_entries)} new hashes")
        print(f"ğŸ“Š Total database: {len(existing_hashes)} hashes")
        
        # Save JSON for detailed metadata
        with open(self.json_file, 'w', encoding='utf-8') as f:
            json.dump(samples, f, indent=2)
        
        print(f"ğŸ’¾ Saved detailed metadata to {self.json_file.name}")
    
    def initialize_database(self):
        """Initialize database with header"""
        self.db_dir.mkdir(parents=True, exist_ok=True)
        
        if not self.db_file.exists():
            header = f"""# MalwareBazaar Hash Database
# Source: https://bazaar.abuse.ch/
# Last Updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
# Format: SHA256|MD5|SHA1|Signature|Tags|FileType|FirstSeen
#
"""
            with open(self.db_file, 'w', encoding='utf-8') as f:
                f.write(header)
            
            print(f"âœ… Initialized database: {self.db_file}")
    
    def run(self, limit=1000):
        """Run the update process"""
        print("="*70)
        print("ğŸ¦  MalwareBazaar Hash Database Updater")
        print("="*70)
        
        self.initialize_database()
        
        samples = self.download_recent_samples(limit)
        
        if not samples:
            print("âš ï¸ Could not download samples. Adding EICAR test file for verification.")
            samples = [{
                "sha256_hash": "275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f",
                "md5_hash": "44d88612fea8a8f36de82e1278abb02f",
                "sha1_hash": "3395856ce81f2b7382dee72602f798b642f14140",
                "signature": "EICAR-Test-File",
                "tags": ["Test", "EICAR"],
                "file_type": "txt",
                "first_seen": datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }]

        if samples:
            self.update_database(samples)
        
        print("\n" + "="*70)
        print(f"âœ… Update complete!")
        print(f"ğŸ“ Database: {self.db_file}")
        print("="*70)


def main():
    import argparse
    
    parser = argparse.ArgumentParser(description="Update MalwareBazaar hash database")
    parser.add_argument("--limit", type=int, default=1000, help="Number of samples to download (default: 1000)")
    parser.add_argument("--query", type=str, help="Query specific hash")
    
    args = parser.parse_args()
    
    updater = MalwareBazaarUpdater()
    
    if args.query:
        print(f"ğŸ” Querying hash: {args.query}")
        result = updater.query_hash(args.query)
        if result:
            print(json.dumps(result, indent=2))
        else:
            print("âŒ Hash not found in MalwareBazaar")
    else:
        updater.run(limit=args.limit)


if __name__ == "__main__":
    main()
