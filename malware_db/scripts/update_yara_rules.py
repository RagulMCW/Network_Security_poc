#!/usr/bin/env python3
"""
YARA Rules Updater

Downloads and updates YARA rules from public repositories
for content-based malware detection.

Sources:
- Yara-Rules/rules (GitHub)
- reversinglabs/reversinglabs-yara-rules
"""

import requests
import zipfile
import shutil
from pathlib import Path
from datetime import datetime
import subprocess
import os


class YaraRulesUpdater:
    
    def __init__(self):
        self.rules_dir = Path(__file__).parent.parent / "yara_rules"
        
        # YARA rule repositories
        self.repos = {
            "Yara-Rules": {
                "url": "https://github.com/Yara-Rules/rules/archive/refs/heads/master.zip",
                "target_dir": self.rules_dir / "Yara-Rules"
            },
            "reversinglabs": {
                "url": "https://github.com/reversinglabs/reversinglabs-yara-rules/archive/refs/heads/develop.zip",
                "target_dir": self.rules_dir / "reversinglabs"
            }
        }
    
    def download_rules(self, repo_name, repo_info):
        """Download YARA rules from GitHub"""
        print(f"\nüîÑ Downloading {repo_name} rules...")
        
        try:
            url = repo_info["url"]
            target_dir = repo_info["target_dir"]
            
            # Download zip file
            response = requests.get(url, timeout=60)
            response.raise_for_status()
            
            # Save zip
            zip_path = self.rules_dir / f"{repo_name}.zip"
            with open(zip_path, 'wb') as f:
                f.write(response.content)
            
            print(f"‚úÖ Downloaded {len(response.content) / (1024*1024):.2f} MB")
            
            # Extract zip
            print(f"üì¶ Extracting rules...")
            with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                zip_ref.extractall(self.rules_dir / "temp")
            
            # Move extracted files to target directory
            temp_dir = self.rules_dir / "temp"
            extracted_dirs = list(temp_dir.glob("*"))
            
            if extracted_dirs:
                extracted_dir = extracted_dirs[0]
                
                # Remove old target directory
                if target_dir.exists():
                    shutil.rmtree(target_dir)
                
                # Move to target
                shutil.move(str(extracted_dir), str(target_dir))
            
            # Cleanup
            zip_path.unlink()
            if temp_dir.exists():
                shutil.rmtree(temp_dir)
            
            print(f"‚úÖ Installed to: {target_dir}")
            
            return True
            
        except Exception as e:
            print(f"‚ùå Error downloading {repo_name}: {str(e)}")
            return False
    
    def compile_rules(self):
        """Compile YARA rules for faster loading"""
        print(f"\nüî® Compiling YARA rules...")
        
        # Check if yara-python is installed
        try:
            import yara
        except ImportError:
            print("‚ö†Ô∏è yara-python not installed. Skipping compilation.")
            print("   Install: pip install yara-python")
            return
        
        # Find all .yar and .yara files
        rule_files = []
        for pattern in ["**/*.yar", "**/*.yara"]:
            rule_files.extend(self.rules_dir.glob(pattern))
        
        print(f"üìä Found {len(rule_files)} YARA rule files")
        
        # Create index file
        index_file = self.rules_dir / "compiled_rules.yar"
        
        with open(index_file, 'w', encoding='utf-8') as f:
            f.write(f"// YARA Rules Index - Compiled {datetime.now()}\n\n")
            
            for rule_file in rule_files:
                # Skip test files and examples
                if any(x in str(rule_file).lower() for x in ['test', 'example', 'sample']):
                    continue
                
                try:
                    # Include rule
                    rel_path = rule_file.relative_to(self.rules_dir)
                    f.write(f'include "{rel_path}"\n')
                except Exception as e:
                    print(f"‚ö†Ô∏è Skipping {rule_file.name}: {str(e)}")
        
        print(f"‚úÖ Created index: {index_file}")
        
        # Try to compile
        try:
            compiled = yara.compile(filepath=str(index_file))
            compiled_file = self.rules_dir / "compiled_rules.yarc"
            compiled.save(str(compiled_file))
            print(f"‚úÖ Compiled rules saved: {compiled_file}")
        except Exception as e:
            print(f"‚ö†Ô∏è Compilation warning: {str(e)}")
            print("   Rules can still be used individually")
    
    def create_custom_rules(self):
        """Create custom YARA rules for common threats"""
        custom_dir = self.rules_dir / "custom"
        custom_dir.mkdir(parents=True, exist_ok=True)
        
        # EICAR test rule
        eicar_rule = """
rule EICAR_Test_File {
    meta:
        description = "Detects EICAR anti-virus test file"
        author = "Network Security POC"
        severity = "low"
        reference = "https://www.eicar.org/"
    
    strings:
        $eicar = "X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    
    condition:
        $eicar
}
"""
        with open(custom_dir / "eicar.yar", 'w') as f:
            f.write(eicar_rule)
        
        # Suspicious HTTP patterns
        http_rule = """
rule Suspicious_HTTP_Payload {
    meta:
        description = "Detects suspicious HTTP payloads"
        author = "Network Security POC"
        severity = "medium"
    
    strings:
        $cmd1 = "cmd.exe" nocase
        $cmd2 = "powershell" nocase
        $cmd3 = "/bin/sh" nocase
        $cmd4 = "/bin/bash" nocase
        
        $suspicious1 = "base64_decode" nocase
        $suspicious2 = "eval(" nocase
        $suspicious3 = "exec(" nocase
        $suspicious4 = "system(" nocase
    
    condition:
        any of ($cmd*) and any of ($suspicious*)
}
"""
        with open(custom_dir / "suspicious_http.yar", 'w') as f:
            f.write(http_rule)
        
        print(f"‚úÖ Created custom rules in: {custom_dir}")
    
    def run(self):
        """Run the update process"""
        print("="*70)
        print("üìú YARA Rules Updater")
        print("="*70)
        
        self.rules_dir.mkdir(parents=True, exist_ok=True)
        
        # Download rules from repositories
        success_count = 0
        for repo_name, repo_info in self.repos.items():
            if self.download_rules(repo_name, repo_info):
                success_count += 1
        
        # Create custom rules
        self.create_custom_rules()
        
        # Compile rules
        self.compile_rules()
        
        print("\n" + "="*70)
        print(f"‚úÖ Update complete! ({success_count}/{len(self.repos)} repos)")
        print(f"üìÅ Rules directory: {self.rules_dir}")
        print("="*70)


def main():
    updater = YaraRulesUpdater()
    updater.run()


if __name__ == "__main__":
    main()
