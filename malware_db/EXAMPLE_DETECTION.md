# Example: Detecting EICAR Malware with LLM

This example demonstrates the complete workflow of malware detection using the MCP agent.

## Scenario

A device downloads the EICAR test file over HTTP. The LLM should:
1. Detect the file in Zeek logs
2. Check hash against malware database
3. Identify it as EICAR test file
4. Quarantine the source device

## Step-by-Step Execution

### 1. User Query
```
User: "Analyze the latest Zeek session for any malware downloads"
```

### 2. LLM Reasoning
```
I need to:
1. Read Zeek logs to see network activity
2. Check files.log for any extracted files
3. Analyze extracted files for malware
4. Take action if threats found
```

### 3. Tool Call 1: Read Zeek Logs
```python
# LLM calls
read_zeek_logs()
```

**Returns:**
```
ğŸ” REAL-TIME ZEEK ANALYSIS - 1 Latest Sessions
================================================================================

ğŸ“¦ session_20251119_114759 (Created: 2025-11-19 11:47:59)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  ğŸ“„ conn.log: 45 entries
#fields	ts	uid	id.orig_h	id.orig_p	id.resp_h	id.resp_p	proto	service
1732012079.123456	C1Ab2Cd3	192.168.6.101	54321	192.168.6.50	80	tcp	http
...

  ğŸ“„ http.log: 12 entries
#fields	ts	uid	id.orig_h	id.orig_p	id.resp_h	id.resp_p	method	host	uri
1732012080.456789	C1Ab2Cd3	192.168.6.101	54321	192.168.6.50	80	GET	malware.test	/eicar.com
...

  ğŸ“„ files.log: 1 entries
#fields	ts	fuid	tx_hosts	rx_hosts	conn_uids	source	mime_type	filename
1732012080.789012	F0bSIo4z	192.168.6.50	192.168.6.101	C1Ab2Cd3	HTTP	application/octet-stream	eicar.com
...

  ğŸ“¦ Extracted Files: 1 files
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  ğŸ“„ extract-1763552877.335898-HTTP-F0bSIo4z8E2zu8tKQ3 (68B) âš ï¸ EICAR!
     X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*

================================================================================
ğŸ“Š Summary: 58 total log entries across 1 sessions
================================================================================
```

### 4. LLM Analysis
```
The LLM notices:
- HTTP download from 192.168.6.101 to malware.test/eicar.com
- File extracted: extract-1763552877.335898-HTTP-F0bSIo4z8E2zu8tKQ3
- Content contains "EICAR" string â†’ suspicious!
- Need to verify with malware database
```

### 5. Tool Call 2: Check Malware Hash
```python
# LLM calls
check_malware_hash(
    file_path="e:/Malware_detection_using_Aiagent/Network_Security_poc/network/zeek_logs/session_20251119_114759/extracted_files/extract-1763552877.335898-HTTP-F0bSIo4z8E2zu8tKQ3",
    check_online=False
)
```

**Returns:**
```
======================================================================
ğŸ” MALWARE HASH CHECK RESULTS
======================================================================

ğŸ“„ File: e:/Malware_detection_using_Aiagent/Network_Security_poc/network/zeek_logs/session_20251119_114759/extracted_files/extract-1763552877.335898-HTTP-F0bSIo4z8E2zu8tKQ3
ğŸ“Š Size: 68 bytes

ğŸ”‘ File Hashes:
  MD5: 44d88612fea8a8f36de82e1278abb02f
  SHA1: 3395856ce81f2b7382dee72602f798b642f14140
  SHA256: 275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f

ğŸ¯ Database Matches: 3

âš ï¸ THREAT DETECTED!

Match #1:
  Database: eicar
  Hash Type: MD5
  Signature: EICAR Test File
  Severity: LOW

Match #2:
  Database: eicar
  Hash Type: SHA1
  Signature: EICAR Test File
  Severity: LOW

Match #3:
  Database: custom
  Hash Type: SHA256
  Description: EICAR Test File
  Severity: LOW

ğŸšï¸ Threat Assessment:
  Threat Level: TEST_FILE
  Threat Score: 10/100

ğŸ’¡ Recommended Action:
  â„¹ï¸ EICAR test file detected (not real malware)
  âœ… Safe to ignore if this is a security test
======================================================================
```

### 6. LLM Decision
```
The file is identified as EICAR test file (not real malware).
Since this is a test/demo environment, I should:
1. Inform the user about the detection
2. Optionally quarantine the device for demonstration
```

### 7. Tool Call 3: Quarantine Device (Optional)
```python
# LLM calls
move_device_to_honeypot(
    device_id="192.168.6.101",
    reason="EICAR test file download detected"
)
```

**Returns:**
```
SUCCESS: Device moved to honeypot network

Device: 192.168.6.101 (vdevice_101)
Reason: EICAR test file download detected
Original IP: 192.168.6.101
Honeypot IP: 192.168.7.101
Traffic Target: 192.168.7.2
Method: iptables DNAT redirect
Status: ISOLATED

Device quarantined. All traffic redirected to honeypot via iptables.
```

### 8. LLM Response to User
```
ğŸ” Malware Analysis Complete

I detected a malware file in the latest Zeek session:

ğŸ“‹ Summary:
- Source Device: 192.168.6.101 (vdevice_101)
- Download URL: http://malware.test/eicar.com
- File Size: 68 bytes
- Detection: EICAR Test File

ğŸ” Hash Analysis:
- MD5: 44d88612fea8a8f36de82e1278abb02f
- SHA256: 275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f
- Match: EICAR test signature (3 database matches)

âœ… Assessment:
This is the EICAR anti-virus test file, commonly used to validate 
malware detection systems. It's not actual malware but a harmless 
test signature.

Threat Level: TEST_FILE (10/100)

ğŸ›¡ï¸ Actions Taken:
- âœ… File identified and logged
- âœ… Device isolated to honeypot network (demo purposes)
- âœ… Traffic rerouted to Beelzebub honeypot

Would you like me to:
1. Restore the device to normal network
2. Analyze other sessions
3. Run additional YARA scans on the file
```

## Alternative: Real Malware Detection

If this were **real malware** (e.g., Emotet trojan):

### Hash Check Result
```
ğŸ¯ Database Matches: 1

âš ï¸ THREAT DETECTED!

Match #1:
  Database: malwarebazaar
  Hash Type: SHA256
  Malware Family: Emotet
  Tags: trojan,banking,spam,botnet
  File Type: exe
  First Seen: 2025-11-10

ğŸšï¸ Threat Assessment:
  Threat Level: MALWARE
  Threat Score: 100/100

ğŸ’¡ Recommended Action:
  ğŸš¨ QUARANTINE IMMEDIATELY - Known malware detected!
  ğŸ”’ Isolate source device to honeypot network
  ğŸ“ Log incident for forensic analysis
```

### LLM Response
```
ğŸš¨ CRITICAL: Real Malware Detected!

ğŸ“‹ Threat Summary:
- Malware Family: Emotet
- Classification: Banking Trojan, Botnet
- Severity: CRITICAL (100/100)
- Source: 192.168.6.101

ğŸ” Actions Taken:
1. âœ… Device QUARANTINED to honeypot network
2. âœ… All traffic redirected to Beelzebub
3. âœ… Incident logged for forensic analysis

âš ï¸ Security Recommendations:
1. DO NOT restore device to production network
2. Perform full system wipe/reimaging
3. Check other devices for lateral movement
4. Review network logs for C2 communication
5. Report to security team

This is REAL malware, not a test file. The device has been 
permanently isolated until manual review.
```

## Usage in Production

To test this workflow yourself:

1. **Start Zeek Monitor**
   ```bash
   cd network/zeek
   START.bat
   ```

2. **Simulate Malware Download**
   ```bash
   cd attackers/malware_attacker
   START.bat
   ```

3. **Query MCP Agent**
   ```bash
   cd mcp_agent
   RUN_AGENT.bat
   
   Query: "Check for malware in the latest Zeek session"
   ```

4. **Expected Result**
   - LLM reads Zeek logs
   - Finds EICAR file
   - Checks hash database
   - Detects EICAR
   - Optionally quarantines device

## Key Learning Points

1. **Hash-based detection is fast** (<1ms lookup)
2. **EICAR is perfect for testing** (safe, well-known signature)
3. **LLM can autonomously detect and respond** to threats
4. **Workflow is fully automated** (no human intervention needed)
5. **Quarantine is immediate** (device isolated in seconds)

## Next Steps

- Try with custom malware signatures
- Test YARA scanning for unknown files
- Set up automatic database updates
- Monitor quarantined devices in honeypot
