# Malware Hash Query Guide

## 2-Step Hash Checking System

This system implements a smart 2-step approach for checking malware hashes:

### Step 1: EICAR Test File Detection
- **Priority**: HIGHEST
- **Action**: Check if hash matches EICAR test file signatures
- **Result**: If EICAR detected, return immediately with `TEST_FILE` status
- **Reason**: EICAR is not real malware, just a test file

### Step 2: Database Query (Local + Online)
- **Priority**: NORMAL
- **Action**: 
  1. Check local databases (MalwareBazaar offline, custom signatures)
  2. If enabled, query MalwareBazaar API for unknown hashes
- **Result**: Return `MALWARE` if found, `CLEAN` if not found

---

## Usage Examples

### 1. Check EICAR Test File (Step 1 - Immediate Return)

```bash
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\malware_db\scripts
python check_hash.py 44d88612fea8a8f36de82e1278abb02f
```

**Expected Output:**
```
üîç Malware Hash Check Results
File: 44d88612fea8a8f36de82e1278abb02f
Matches: 1

‚ö†Ô∏è THREAT DETECTED!
  Database: eicar
  Hash Type: md5
  Signature: EICAR Test File

Check Stage: EICAR_DETECTED
Threat Level: TEST_FILE
Threat Score: 10/100
```

### 2. Check Hash with Online API

```bash
# Query MalwareBazaar API for a known malware hash
python check_hash.py 7de2c1bf58bce09eecc70476747d88a26163c3d6bb1d85235c24a558d1f16754 --online
```

**Expected Output (if found):**
```
üîç Malware Hash Check Results
Hash: 7de2c1bf58bce09eecc70476747d88a26163c3d6bb1d85235c24a558d1f16754

Check Stage: ONLINE_API
üåê Online Check (MalwareBazaar):
  ‚ö†Ô∏è Hash found in online database!
  Signature: Emotet
  File Type: exe
  Tags: trojan, banking
  First Seen: 2024-01-15 10:30:00

Threat Level: MALWARE
Threat Score: 100/100
```

### 3. Check File

```bash
python check_hash.py E:\path\to\suspicious_file.exe --online
```

---

## API Configuration

### Environment Variable (Recommended)
```bash
# Set your MalwareBazaar API key
set MALWAREBAZAAR_API_KEY=your_api_key_here
```

### Default API Key
The script includes a default API key:
```
f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff
```

---

## MalwareBazaar API Details

### Endpoint
```
POST https://mb-api.abuse.ch/api/v1/
```

### Request Format
```bash
curl -X POST https://mb-api.abuse.ch/api/v1/ \
  -H "Auth-Key: YOUR-AUTH-KEY-HERE" \
  --data "query=get_info&hash=HASH_VALUE"
```

### Response Fields

| Field | Description |
|-------|-------------|
| `query_status` | `ok`, `hash_not_found`, `illegal_hash`, `no_hash_provided` |
| `sha256_hash` | SHA256 hash of the malware sample |
| `md5_hash` | MD5 hash |
| `sha1_hash` | SHA1 hash |
| `signature` | Malware family (e.g., Emotet, TrickBot) |
| `tags` | Array of tags (e.g., trojan, ransomware) |
| `file_type` | File type (exe, dll, jar, etc.) |
| `first_seen` | First detection timestamp (UTC) |
| `reporter` | Who reported the sample |

---

## Python API Usage

```python
from check_hash import MalwareHashChecker

# Initialize checker
checker = MalwareHashChecker()

# Check file (2-step: EICAR ‚Üí Local DB ‚Üí Online API)
result = checker.check_file("suspicious.exe", check_online=True)

print(f"Threat Level: {result['threat_level']}")
print(f"Check Stage: {result['check_stage']}")

if result['matches']:
    for match in result['matches']:
        print(f"Found in: {match['database']}")
        print(f"Signature: {match['signature']}")
```

---

## Check Stages

| Stage | Description |
|-------|-------------|
| `EICAR_DETECTED` | EICAR test file found (Step 1) |
| `LOCAL_DATABASES` | Checked local databases only |
| `ONLINE_API` | Queried MalwareBazaar API |

---

## Batch Files

### CHECK_HASH.bat
```batch
@echo off
cd /d "%~dp0scripts"
python check_hash.py %*
pause
```

**Usage:**
```batch
CHECK_HASH.bat 44d88612fea8a8f36de82e1278abb02f
CHECK_HASH.bat suspicious.exe --online
```

---

## Requirements

### Without Online Checking (Local Only)
- Python 3.x
- No external dependencies

### With Online Checking
- Python 3.x
- `requests` library

**Install requests:**
```bash
# Via pip (if available)
python -m pip install requests

# Via MSYS2/pacman
pacman -S mingw-w64-ucrt-x86_64-python-requests

# Via conda
conda install requests
```

---

## Testing

### Test EICAR Hashes
```bash
# MD5
python check_hash.py 44d88612fea8a8f36de82e1278abb02f

# SHA1
python check_hash.py 3395856ce81f2b7382dee72602f798b642f14140

# SHA256
python check_hash.py 275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f
```

All should return `TEST_FILE` immediately (Step 1).

---

## Error Handling

### No requests module
```
ERROR: requests module not installed
Install: python -m pip install requests
```

### Invalid hash format
```
query_status: illegal_hash
Error: Invalid hash format
```

### API timeout
```
Online Check Error: Request timeout (10s)
```

### Rate limiting
MalwareBazaar API limits:
- **Free**: 200 requests/day
- **Registered**: Higher limits

---

## Integration with MCP Agent

The MCP server includes this checker in the `check_malware_hash` tool:

```python
# LLM can call this tool
result = check_malware_hash(
    file_path="extract-12345-HTTP-abc123",
    check_online=True
)
```

The tool automatically:
1. Resolves file paths (handles partial paths from Zeek logs)
2. Runs 2-step check (EICAR ‚Üí Local ‚Üí Online)
3. Returns formatted threat assessment

---

## Troubleshooting

### Hash not found
- Verify hash is correct (SHA256, SHA1, or MD5)
- Try online checking with `--online` flag
- Hash may be unknown to MalwareBazaar

### API errors
- Check API key in environment variable
- Verify internet connectivity
- Check API rate limits

### File not found
- Use absolute path
- For Zeek extracted files, provide just filename
  - Tool auto-searches in `network/zeek_logs/*/extracted_files/`
