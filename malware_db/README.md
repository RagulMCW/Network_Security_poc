# Malware Database for Zeek Integration

This directory contains malware hash databases and YARA rules for comparing extracted files from Zeek network monitoring.

## ğŸ“ Structure

```
malware_db/
â”œâ”€â”€ hash_databases/          # Malware hash databases (MD5, SHA1, SHA256)
â”‚   â”œâ”€â”€ malwarebazaar.txt   # MalwareBazaar hashes
â”‚   â”œâ”€â”€ virustotal.txt      # VirusTotal known malware
â”‚   â”œâ”€â”€ custom_malware.txt  # Custom malware signatures
â”‚   â””â”€â”€ eicar_test.txt      # EICAR test signatures
â”œâ”€â”€ yara_rules/             # YARA rules for content-based detection
â”‚   â”œâ”€â”€ malware/            # Malware family rules
â”‚   â”œâ”€â”€ webshells/          # Web shell detection
â”‚   â””â”€â”€ custom/             # Custom detection rules
â”œâ”€â”€ scripts/                # Database management scripts
â”‚   â”œâ”€â”€ update_malwarebazaar.py    # Update MalwareBazaar DB
â”‚   â”œâ”€â”€ update_yara_rules.py       # Update YARA rules
â”‚   â””â”€â”€ check_hash.py              # Standalone hash checker
â””â”€â”€ README.md
```

## ğŸ—„ï¸ Malware Hash Databases Sources

### 1. **MalwareBazaar** (abuse.ch)
- **URL**: https://bazaar.abuse.ch/
- **API**: https://bazaar.abuse.ch/api/
- **Free**: Yes, API available
- **Format**: CSV with MD5, SHA256, malware family, tags
- **Update Frequency**: Daily
- **Coverage**: 1M+ malware samples

### 2. **VirusShare** 
- **URL**: https://virusshare.com/
- **Format**: Hash lists (MD5)
- **Free**: Yes (registration required)
- **Coverage**: 48M+ malware samples

### 3. **Vx-Underground**
- **URL**: https://www.vx-underground.org/
- **Format**: Various (samples and hashes)
- **Free**: Yes
- **Coverage**: Malware samples and APT reports

### 4. **YARA Rules Repository**
- **URL**: https://github.com/Yara-Rules/rules
- **Format**: YARA rule files
- **Free**: Yes (GPL-2.0)
- **Coverage**: 1000+ detection rules

### 5. **Malware Hash Registry (Team Cymru)**
- **URL**: https://www.team-cymru.com/mhr
- **Format**: DNS query (hash.malware.hash.cymru.com)
- **Free**: Yes
- **Usage**: DNS lookup for hash reputation

## ğŸ”§ Setup Instructions

### Step 1: Install Dependencies
```bash
pip install requests pyyaml yara-python tqdm
```

### Step 2: Download Initial Databases
```bash
cd malware_db/scripts
python update_malwarebazaar.py
python update_yara_rules.py
```

### Step 3: Verify Installation
```bash
python check_hash.py <file_hash>
```

## ğŸš€ Integration with MCP Server

The MCP server includes a `check_malware_hash` tool that:

1. **Computes file hashes** (MD5, SHA1, SHA256)
2. **Checks against local databases**
3. **Queries online APIs** (optional)
4. **Returns threat intelligence**

### Usage from LLM

```python
# LLM detects suspicious file in Zeek logs
extracted_file = "/path/to/extracted_file"

# Trigger malware hash check
result = check_malware_hash(file_path=extracted_file, check_online=True)

# Result contains:
# - Hash values (MD5, SHA1, SHA256)
# - Database matches (MalwareBazaar, custom)
# - Malware family/tags
# - Threat score (0-100)
# - Recommended action (CLEAN, SUSPICIOUS, MALWARE)
```

## ğŸ“Š Hash Database Format

### malwarebazaar.txt
```
# MalwareBazaar Hash Database
# Updated: 2025-11-19
# Format: SHA256|MD5|Malware_Family|Tags
a1b2c3d4...|e5f6g7h8...|Emotet|trojan,banking,spam
```

### custom_malware.txt
```
# Custom Malware Signatures
# Format: HASH_TYPE:HASH_VALUE|DESCRIPTION|SEVERITY
SHA256:3395856ce81f2b7382dee72602f798b642f14140|EICAR Test File|LOW
MD5:44d88612fea8a8f36de82e1278abb02f|EICAR Test File|LOW
```

### eicar_test.txt
```
# EICAR Test Signatures
MD5:44d88612fea8a8f36de82e1278abb02f
SHA1:3395856ce81f2b7382dee72602f798b642f14140
SHA256:275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f
```

## ğŸ” YARA Rules Integration

YARA rules provide **content-based detection** (patterns, strings, behaviors).

### Example: Detect EICAR in files
```yara
rule EICAR_Test_File {
    meta:
        description = "Detects EICAR test file"
        severity = "low"
    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"
    condition:
        $eicar
}
```

## ğŸ”„ Automatic Updates

### Daily Updates (Scheduled Task)
```bash
# Windows Task Scheduler
schtasks /create /tn "Update Malware DB" /tr "python update_malwarebazaar.py" /sc daily /st 02:00
```

### Manual Update
```bash
cd malware_db/scripts
python update_malwarebazaar.py
python update_yara_rules.py
```

## ğŸ›¡ï¸ Security Best Practices

1. **Offline-First**: Primary checks use local databases (fast, no API rate limits)
2. **Online Fallback**: Query APIs only for unknown hashes
3. **API Keys**: Store in environment variables (`.env` file)
4. **Rate Limiting**: Respect API quotas (MalwareBazaar: 200 req/day)
5. **Quarantine**: Isolate suspicious files before scanning

## ğŸ“ˆ Performance

- **Local Hash Lookup**: <1ms (in-memory hash set)
- **YARA Scan**: 10-100ms per file
- **Online API**: 200-500ms (network dependent)

## ğŸ”— API Integration Examples

### MalwareBazaar API
```python
import requests

def query_malwarebazaar(sha256_hash):
    url = "https://mb-api.abuse.ch/api/v1/"
    data = {"query": "get_info", "hash": sha256_hash}
    response = requests.post(url, data=data)
    return response.json()
```

### Team Cymru MHR (DNS-based)
```python
import dns.resolver

def query_team_cymru_mhr(sha1_hash):
    query = f"{sha1_hash}.malware.hash.cymru.com"
    try:
        answers = dns.resolver.resolve(query, "TXT")
        return str(answers[0])
    except:
        return "Not found"
```

## ğŸ“ License

- MalwareBazaar: CC0 (Public Domain)
- YARA Rules: GPL-2.0
- Custom Rules: MIT License
