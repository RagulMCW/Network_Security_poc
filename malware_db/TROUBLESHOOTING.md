# Malware Detection Troubleshooting Guide

## Common Issues and Solutions

### Issue 1: File Path Not Found

**Symptom:**
```
‚ùå ERROR: File not found: /tmp/extract-1763552877.58295-HTTP-FQmdipn4669nGIAJj
```

**Root Cause:**
- LLM uses Linux/WSL paths (`/tmp/...`) but files are in Windows
- Zeek extracts files to Windows directory: `E:\...\network\zeek_logs\session_*\extracted_files\`

**Solution (Already Implemented):**
The MCP server now auto-translates paths:
1. Detects Linux-style paths
2. Extracts filename only
3. Searches in all Zeek sessions
4. Uses the most recent match

**LLM Usage:**
```python
# Any of these will work:
check_malware_hash("/tmp/extract-1763552877.58295-HTTP-FQmdipn4669nGIAJj")
check_malware_hash("E:\\...\\extracted_files\\extract-1763552877.58295-HTTP-FQmdipn4669nGIAJj")
check_malware_hash("extract-1763552877.58295-HTTP-FQmdipn4669nGIAJj")
```

### Issue 2: Query Timeout (120s)

**Symptom:**
```
‚ùå Error: Query timeout (120s). The agent is still processing.
```

**Root Causes:**
1. **Large Zeek logs** - Reading all sessions takes time
2. **Too many tool calls** - LLM calling tools sequentially
3. **Network latency** - Online hash checks are slow
4. **YARA compilation** - First-time YARA rule loading

**Solutions:**

#### A. Optimize Zeek Log Reading
```python
# Instead of reading ALL logs:
read_zeek_logs()  # Reads last 5 sessions (already optimized)

# LLM should focus on latest session only
# Extract session name from read_zeek_logs() output
# Then use read_file() for specific log files
```

#### B. Avoid Online Checks Initially
```python
# Fast (local only):
check_malware_hash(file_path, check_online=False)  # <1ms

# Slow (includes API):
check_malware_hash(file_path, check_online=True)   # 200-500ms
```

#### C. Batch Operations
```python
# DON'T do this (sequential):
for file in files:
    check_malware_hash(file)  # Slow!

# DO this instead (parallel in LLM thinking):
# 1. Read zeek logs once
# 2. Identify ALL suspicious files
# 3. Check hashes in batch (if MCP supports parallel calls)
```

#### D. Use Targeted Analysis
```python
# Instead of analyzing everything:
# 1. read_zeek_logs() ‚Üí see summary
# 2. If files.log has entries ‚Üí focus on those
# 3. If EICAR string in output ‚Üí only check those files
```

### Issue 3: Hash Not Found but File Contains EICAR

**Symptom:**
```
File content: {"content":"X5O!P%@AP[4\PZX54...EICAR..."}
Result: Threat Level: CLEAN
```

**Root Cause:**
- File is JSON/text wrapper around EICAR
- Hash is computed on entire file (including JSON)
- EICAR hash database only has pure EICAR file hash

**Solutions:**

#### A. Use YARA Scanning (Content-Based)
```python
# Hash check failed because of JSON wrapper
check_malware_hash(file_path)  # Returns: CLEAN

# YARA scans file content (finds EICAR string)
scan_with_yara(file_path, "eicar")  # Returns: MATCH!
```

#### B. Extract Content First
```python
# If file is JSON and read_file() shows EICAR string:
# 1. Extract the "content" field
# 2. Write to temporary file
# 3. Check hash of extracted content
```

#### C. Update Custom Database
```python
# Add the JSON wrapper hash to custom database:
# malware_db/hash_databases/custom_malware.txt
SHA256:bf01d943e33480459c84010382e0559daea5430a168356aba9fc99efed29e26a|EICAR in JSON|MEDIUM
```

### Issue 4: YARA Rules Not Found

**Symptom:**
```
‚ùå ERROR: YARA rules directory not found
```

**Solution:**
```bash
cd malware_db
SETUP.bat

# Or manually:
cd malware_db/scripts
python update_yara_rules.py
```

### Issue 5: yara-python Not Installed

**Symptom:**
```
‚ùå ERROR: yara-python not installed
```

**Solution:**
```bash
pip install yara-python

# If build fails on Windows:
# Download pre-compiled wheel from:
# https://github.com/VirusTotal/yara-python/releases
```

### Issue 6: MalwareBazaar Database Empty

**Symptom:**
```
üìä Database Statistics
malwarebazaar:
  md5_count: 0
  sha1_count: 0
  sha256_count: 0
```

**Solution:**
```bash
cd malware_db
UPDATE_MALWAREBAZAAR.bat

# Or manually:
cd malware_db/scripts
python update_malwarebazaar.py --limit 1000
```

### Issue 7: False Positives from YARA

**Symptom:**
```
YARA scan shows: Suspicious_HTTP_Payload
But file is legitimate application traffic
```

**Solution:**

#### A. Review the Match
```python
# Check which strings matched
scan_with_yara(file_path, "suspicious_http")
# Review the "Matched Strings" section
```

#### B. Whitelist Specific Files
```python
# Add to custom database as CLEAN
# malware_db/hash_databases/custom_malware.txt
SHA256:abc123...|Legitimate App Traffic|WHITELIST
```

#### C. Disable/Modify Rule
```bash
# Edit the rule to add exceptions
# malware_db/yara_rules/custom/suspicious_http.yar
```

## Recommended LLM Workflow

### Efficient Malware Detection Workflow

```
USER QUERY: "Check for malware in network"

STEP 1: Read Zeek Logs (Fast)
‚îú‚îÄ read_zeek_logs()
‚îú‚îÄ Scan output for keywords: "EICAR", "malware", "suspicious"
‚îî‚îÄ Note extracted files from files.log

STEP 2: Quick Triage
‚îú‚îÄ If "EICAR" in output ‚Üí Likely test file
‚îú‚îÄ If files.log has 0 entries ‚Üí No files to check
‚îî‚îÄ If files.log has entries ‚Üí Proceed to Step 3

STEP 3: Hash Check (Fast - Local Only)
‚îú‚îÄ Get file path from read_zeek_logs output
‚îú‚îÄ Call: check_malware_hash(file_path, check_online=False)
‚îî‚îÄ Result:
    ‚îú‚îÄ MALWARE ‚Üí Proceed to Step 5 (Quarantine)
    ‚îú‚îÄ TEST_FILE ‚Üí Report as EICAR test
    ‚îî‚îÄ CLEAN ‚Üí Proceed to Step 4 (Content Check)

STEP 4: Content-Based Check (If Hash is Clean)
‚îú‚îÄ If file has suspicious patterns (base64, eval, powershell):
‚îÇ   ‚îî‚îÄ Call: scan_with_yara(file_path, "suspicious_http")
‚îú‚îÄ If EICAR string visible in read_file():
‚îÇ   ‚îî‚îÄ Call: scan_with_yara(file_path, "eicar")
‚îî‚îÄ If match found ‚Üí Treat as SUSPICIOUS

STEP 5: Quarantine Action
‚îú‚îÄ Identify source IP from conn.log or http.log
‚îú‚îÄ Call: move_device_to_honeypot(source_ip, reason)
‚îî‚îÄ Report to user

STEP 6: Report Findings
‚îî‚îÄ Concise summary with:
    ‚îú‚îÄ Threat level
    ‚îú‚îÄ Malware family (if known)
    ‚îú‚îÄ Actions taken
    ‚îî‚îÄ Recommendations
```

## Performance Optimization Tips

### 1. Minimize Tool Calls
```python
# BAD: 10+ tool calls
read_zeek_logs()
read_file(conn_log)
read_file(http_log)
read_file(dns_log)
check_malware_hash(file1)
check_malware_hash(file2)
# ... timeout!

# GOOD: 2-3 tool calls
read_zeek_logs()  # Already includes conn, http, dns, files
# Analyze the output
check_malware_hash(file_path)  # Only if suspicious file found
```

### 2. Use Existing Output
```python
# read_zeek_logs() already shows:
# - Extracted files with EICAR markers
# - File content preview
# - All log entries

# Don't call read_file() again for same data!
```

### 3. Early Termination
```python
# If read_zeek_logs() shows:
# - No extracted files
# - No suspicious patterns
# - All traffic looks normal

# STOP HERE - don't call check_malware_hash()
# Report: "No threats detected"
```

### 4. Prioritize Local Checks
```python
# Always start with offline/local:
check_malware_hash(file, check_online=False)  # <1ms

# Only use online if:
# - Local check is CLEAN
# - File is highly suspicious
# - User explicitly requested thorough check
```

## Testing Your Setup

### Test 1: EICAR Detection (Basic)
```bash
cd malware_db
CHECK_HASH.bat test_eicar.txt
```

Expected: `Threat Level: TEST_FILE`

### Test 2: MCP Integration (Basic)
```python
# In MCP agent query:
"Check the hash of file: e:/Malware_detection_using_Aiagent/Network_Security_poc/malware_db/test_eicar.txt"

Expected: Tool calls check_malware_hash() and returns EICAR detection
```

### Test 3: Zeek Integration (Full)
```python
# In MCP agent query:
"Read Zeek logs and check for any malware"

Expected workflow:
1. read_zeek_logs() ‚Üí finds extracted files
2. check_malware_hash(extracted_file) ‚Üí detects threats
3. Concise report
```

### Test 4: YARA Content Detection
```python
"Scan extracted files with YARA for EICAR patterns"

Expected: scan_with_yara() finds EICAR_Test_File rule match
```

## Debugging Checklist

- [ ] **Database Setup**: Run `malware_db/SETUP.bat`
- [ ] **Database Stats**: Run `CHECK_HASH.bat --stats`
- [ ] **EICAR Test**: `CHECK_HASH.bat test_eicar.txt` works
- [ ] **Path Translation**: MCP server handles `/tmp/` paths
- [ ] **Zeek Logs**: `network/zeek_logs/session_*/` directories exist
- [ ] **Extracted Files**: `extracted_files/extract-*` files present
- [ ] **MCP Server**: Latest code with path translation
- [ ] **Python Packages**: `requests`, `yara-python` installed

## Quick Fixes

### Fix Timeout Issues
```python
# Reduce scope of analysis:
"Check only the latest Zeek session for malware"

# Instead of:
"Analyze all network traffic for threats"  # Too broad!
```

### Fix Path Issues
```bash
# Update MCP server (already done):
git pull  # Get latest server.py with path translation

# Restart MCP server:
cd mcp_agent
RUN_AGENT.bat
```

### Fix Missing Databases
```bash
cd malware_db
SETUP.bat  # One-time setup
UPDATE_MALWAREBAZAAR.bat  # Update hashes
```

## Support Resources

- **Full Guide**: `malware_db/INTEGRATION_GUIDE.md`
- **Quick Reference**: `malware_db/QUICK_REFERENCE.md`
- **Example**: `malware_db/EXAMPLE_DETECTION.md`
- **Main README**: `malware_db/README.md`
