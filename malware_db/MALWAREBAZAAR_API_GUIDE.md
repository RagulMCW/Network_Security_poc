# Malware Hash Query System - MalwareBazaar API Integration

## Overview

This system implements a **2-step malware detection** process that optimizes performance and API usage:

1. **Step 1: EICAR Test File Check** (Immediate Return)
   - Checks if hash matches EICAR test signatures
   - Returns immediately if found (no API call needed)
   - Severity: LOW (not real malware)

2. **Step 2: MalwareBazaar API Query** (If Step 1 fails)
   - Queries MalwareBazaar public API
   - Uses API authentication key
   - Returns detailed malware intelligence

---

## API Configuration

### MalwareBazaar API

- **Endpoint**: `https://mb-api.abuse.ch/api/v1/`
- **Method**: HTTP POST (form data)
- **Authentication**: API Key in `Auth-Key` header
- **Your API Key**: `f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff`

### Setting API Key

#### Option 1: Environment Variable (Recommended)

```bash
# Windows (PowerShell)
$env:MALWAREBAZAAR_API_KEY = "f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff"

# Windows (Command Prompt)
set MALWAREBAZAAR_API_KEY=f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff

# Linux/Mac
export MALWAREBAZAAR_API_KEY="f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff"
```

#### Option 2: Hardcoded in Script (Already Configured)

The API key is already set as a fallback in `check_hash.py`:

```python
api_key = os.getenv("MALWAREBAZAAR_API_KEY", "f5b289bbb89ad8a3483fa3548e69d43a7751e16189a2caff")
```

---

## API Request/Response Format

### Request Format

```http
POST /api/v1/ HTTP/1.1
Host: mb-api.abuse.ch
Auth-Key: YOUR-API-KEY-HERE
Content-Type: application/x-www-form-urlencoded

query=get_info&hash=094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d
```

### Response Fields

| Field | Example | Description |
|-------|---------|-------------|
| `query_status` | `ok`, `hash_not_found`, `illegal_hash` | Query result status |
| `sha256_hash` | `e167b20f1acf48f7ce0ae33a218e...` | SHA256 hash |
| `sha3_384_hash` | `19142fcef2eb63b4a000506d81218...` | SHA3-384 hash |
| `sha1_hash` | `eb0e81598d8526d88cac4695a3e9360cc8fbb331` | SHA1 hash |
| `md5_hash` | `7338b335ad5471cb67658f27836374f0` | MD5 hash |
| `first_seen` | `2020-02-28 05:57:01` | First seen timestamp (UTC) |
| `last_seen` | `2020-03-01 08:11:45` | Last seen timestamp (UTC) |
| `file_name` | `Jamil Marzouka Co.pdf.jar` | Original filename |
| `file_size` | `62118` | File size in bytes |
| `file_type_mime` | `application/x-dosexec` | MIME type |
| `file_type` | `jar` | File type |
| `reporter` | `viql` | Twitter handle (or anonymous) |
| `origin_country` | `US` | Country code |
| `signature` | `Adwind` | Malware family |
| `tags` | `["Adwind", "jar", "qua"]` | Tags |
| `imphash` | `f34d5f2d4577ed6d9ceec516c1f5a744` | Import hash (PE files) |
| `tlsh` | `11B2194E3FA98856C4BC177486B...` | TLSH hash |
| `ssdeep` | `1536:sGZWpdxayQAcj7gwluW14Z2II0oc...` | Fuzzy hash |
| `delivery_method` | `email_attachment`, `web_download` | Distribution method |
| `yara_rules` | `[{rule_name, author, description}]` | YARA rules triggered |
| `vendor_intel` | `{ANY.RUN: {...}, CAPE: {...}}` | Vendor analysis |

---

## Usage Examples

### 1. Check EICAR Test File (Step 1)

```bash
# By Hash (MD5)
python scripts/check_hash.py 44d88612fea8a8f36de82e1278abb02f

# Expected Output:
# ‚úÖ EICAR Test File detected
# Check Stage: EICAR_DETECTED
# Threat Level: TEST_FILE
# Threat Score: 10/100
```

### 2. Check Known Malware (Step 2 - API)

```bash
# Query MalwareBazaar API
python scripts/check_hash.py 094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d --online

# Expected Output:
# üåê Online Check (MalwareBazaar):
# Query Status: ok
# ‚ö†Ô∏è MALWARE FOUND IN MALWAREBAZAAR DATABASE!
# Signature/Family: AsyncRAT
# File Type: exe
# Tags: ['AsyncRAT', 'rat', 'trojan']
```

### 3. Check File by Path

```bash
# Check EICAR test file
python scripts/check_hash.py test_eicar.txt

# Check with online lookup
python scripts/check_hash.py suspicious_file.exe --online
```

### 4. Check Clean Hash

```bash
python scripts/check_hash.py 0000000000000000000000000000000000000000000000000000000000000000 --online

# Expected Output:
# ‚úÖ Hash not found in MalwareBazaar database
# Threat Level: CLEAN
# Threat Score: 0/100
```

---

## Python API Usage

### Basic Check

```python
from check_hash import MalwareHashChecker

# Initialize checker
checker = MalwareHashChecker()

# Check a hash
matches = checker.check_hash("44d88612fea8a8f36de82e1278abb02f")

if matches:
    print(f"Threat detected: {matches[0]['signature']}")
```

### File Check with Online Query

```python
# Check file (2-step process)
result = checker.check_file("suspicious.exe", check_online=True)

print(f"Threat Level: {result['threat_level']}")
print(f"Check Stage: {result['check_stage']}")

if result['threat_level'] == 'MALWARE':
    print("‚ö†Ô∏è MALWARE DETECTED!")
    for match in result['matches']:
        print(f"  Signature: {match['signature']}")
```

### Direct API Query

```python
# Query MalwareBazaar API
api_result = checker._check_online(
    "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d",
    hash_type="sha256"
)

if api_result['found']:
    print(f"Malware Family: {api_result['signature']}")
    print(f"Tags: {api_result['tags']}")
    print(f"First Seen: {api_result['first_seen']}")
```

---

## Check Stages

The system uses different check stages to optimize performance:

| Stage | Description | API Called? |
|-------|-------------|-------------|
| `EICAR_DETECTED` | EICAR test file found immediately | ‚ùå No |
| `LOCAL_DATABASES` | Found in local databases (no online check) | ‚ùå No |
| `ONLINE_API` | Queried MalwareBazaar API | ‚úÖ Yes |

---

## Response Codes

### Query Status Values

| Status | Meaning | Action |
|--------|---------|--------|
| `ok` | Hash found in database | Return malware details |
| `hash_not_found` | Hash not in database | File is likely clean |
| `illegal_hash` | Invalid hash format | Check hash format |
| `no_hash_provided` | Missing hash parameter | Provide hash value |
| `http_post_expected` | Wrong HTTP method | Use POST |

---

## Integration with MCP Server

The MCP server (`mcp_agent/server/server.py`) automatically uses this 2-step system:

```python
# MCP tool call
result = check_malware_hash(
    file_path="extract-1763552877.58295-HTTP-FQmdipn4669nGIAJj",
    check_online=True
)
```

### MCP Tool Features

1. **Smart Path Resolution**: Automatically finds files in Zeek logs
2. **2-Step Checking**: EICAR ‚Üí Local DB ‚Üí Online API
3. **Detailed Reports**: Returns comprehensive threat intelligence
4. **API Rate Limiting**: Only queries when necessary

---

## Testing

### Run Test Suite

```bash
# Python test script (comprehensive)
python test_malware_query.py

# Batch file test (Windows)
TEST_MALWARE_QUERY.bat
```

### Manual Tests

```bash
# Test 1: EICAR (should return immediately)
python scripts/check_hash.py 275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f

# Test 2: Known malware (queries API)
python scripts/check_hash.py 094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d --online

# Test 3: Clean hash (queries API, not found)
python scripts/check_hash.py 0000000000000000000000000000000000000000000000000000000000000000 --online

# Test 4: View statistics
python scripts/check_hash.py --stats
```

---

## Performance Optimization

### Why 2-Step Process?

1. **Step 1 (EICAR)**: 
   - < 1ms (in-memory hash lookup)
   - No API call needed
   - Immediate return for test files

2. **Step 2 (API)**:
   - 200-500ms (network latency)
   - Only called when Step 1 fails
   - Saves API quota for real threats

### API Rate Limits

- **MalwareBazaar Free Tier**: 200 requests/day
- **Optimization**: Only query unknown hashes
- **Caching**: Local database reduces API calls

---

## Troubleshooting

### API Errors

#### Error: "Request timeout (10s)"
**Solution**: Check network connection or increase timeout

#### Error: "illegal_hash"
**Solution**: Verify hash format (MD5: 32 chars, SHA1: 40 chars, SHA256: 64 chars)

#### Error: "Network error: ..."
**Solution**: Check firewall/proxy settings

### Hash Not Found

If a hash is not found in MalwareBazaar:
- It may be a **clean file** (good!)
- It may be **newly discovered** malware (not yet in database)
- It may be a **custom/targeted** malware

**Recommendation**: Analyze file with additional tools (YARA, sandbox)

---

## Example API Responses

### Successful Query (Malware Found)

```json
{
  "query_status": "ok",
  "data": [
    {
      "sha256_hash": "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d",
      "md5_hash": "7338b335ad5471cb67658f27836374f0",
      "sha1_hash": "eb0e81598d8526d88cac4695a3e9360cc8fbb331",
      "first_seen": "2020-02-28 05:57:01",
      "last_seen": "2020-03-01 08:11:45",
      "file_name": "malware.exe",
      "file_size": 62118,
      "file_type": "exe",
      "signature": "AsyncRAT",
      "tags": ["AsyncRAT", "rat", "trojan"],
      "reporter": "abuse_ch"
    }
  ]
}
```

### Hash Not Found

```json
{
  "query_status": "hash_not_found"
}
```

---

## Next Steps

1. **Update Local Databases**: Run `UPDATE_MALWAREBAZAAR.bat` regularly
2. **Monitor API Usage**: Track daily API calls (200 limit)
3. **Integrate YARA**: Add content-based detection
4. **Add Caching**: Store API results to reduce future queries

---

## Resources

- **MalwareBazaar API Docs**: https://bazaar.abuse.ch/api/
- **EICAR Test File**: https://www.eicar.org/
- **Project Structure**: See `docs/PROJECT_STRUCTURE.md`

---

## Contact

For issues or questions about the malware detection system:
- Check `malware_db/TROUBLESHOOTING.md`
- Review `malware_db/QUICK_REFERENCE.md`
- See integration guide: `malware_db/INTEGRATION_GUIDE.md`
