# Malware Detection Solution

## Problem
- Large malware files (5.5MB) take longer to transfer than the Zeek session duration (10s)
- Zeek cannot calculate hash of incomplete files
- Need hash immediately for LLM to query MalwareBazaar database

## Solution: Use HTTP Headers

The malware sender script **already sends the hash** in HTTP headers:
```
X-Original-Hash: a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f
X-Filename: malware_sample.apk
X-File-Size: 5501723
```

### How It Works

1. **Attacker Script Calculates Hash** (`send_malware_sample.py`)
   - Reads malware file: `sample.apk`
   - Calculates SHA256: `a864d996...`
   - Sends hash in HTTP headers

2. **Zeek Captures Headers** (`local.zeek`)
   - Monitors HTTP traffic
   - Extracts `X-Original-Hash` header
   - Logs to `MALWARE_HASHES.log`

3. **LLM Reads Hash** (MCP Agent)
   - Reads `MALWARE_HASHES.log`
   - Extracts SHA256 hash
   - Queries MalwareBazaar API
   - Reports if malware is known

## Files to Check

```
# Malware hash log (created by Zeek)
E:\Malware_detection_using_Aiagent\Network_Security_poc\network\zeek_logs\MALWARE_HASHES.log

# Format:
2025-11-20 07:15:47 | MALWARE HASH DETECTED | IP: 192.168.6.200 | Hash: a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f
2025-11-20 07:15:47 | FILENAME | 192.168.6.200 | File: malware_sample.apk
2025-11-20 07:15:47 | FILE SIZE | 192.168.6.200 | Size: 5501723 bytes
```

## Test the System

### Step 1: Send Malware Sample
```powershell
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\attackers\malware_attacker
wsl docker exec malware_attacker python3 /app/send_malware_sample.py
```

### Step 2: Check for Hash in Logs
```powershell
# Wait 2 seconds for Zeek to process
Start-Sleep -Seconds 2

# Check the malware hashes log
Get-Content E:\Malware_detection_using_Aiagent\Network_Security_poc\network\zeek_logs\MALWARE_HASHES.log -Tail 10
```

### Step 3: LLM Queries Database
The MCP agent will:
1. Read the hash from `MALWARE_HASHES.log`
2. Query MalwareBazaar: `https://mb-api.abuse.ch/api/v1/`
3. Check if hash matches known malware
4. Report findings

## Why This Solution is Better

✅ **Fast**: Hash appears in logs within 1 second  
✅ **Simple**: No need to wait for full file transfer  
✅ **Reliable**: HTTP headers are captured first  
✅ **Efficient**: No file extraction or hash calculation needed by Zeek  

## Troubleshooting

### If MALWARE_HASHES.log is empty:
1. Check Zeek is running: `wsl docker ps`
2. Check Zeek logs for errors: `wsl docker logs network-monitor --tail 50`
3. Verify HTTP headers case sensitivity (might be `x-original-hash` lowercase)

### If hash not detected:
1. Verify script sends headers: Check `send_malware_sample.py` line 40-45
2. Check HTTP log: `Get-Content zeek_logs/session_*/http.log | Select-String "api/files/upload"`
3. Enable debug logging in `local.zeek`

## Expected Hash
The sample malware APK has hash:
```
a864d996cb6607a470469d9192cfb8abd3797a8ad90bea7ce00caa1195b40e5f
```

This should be checked against MalwareBazaar database for known threats.
