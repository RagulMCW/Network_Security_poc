# ğŸ¦  Malware Attacker Detection Guide

## ğŸ“– **What Happens When You Run Malware Attacker**

### **Simple Explanation**

When you start the malware attacker, it simulates **4 different malware behaviors** running at the same time:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MALWARE ATTACKER CONTAINER (192.168.6.134)    â”‚
â”‚                                                 â”‚
â”‚  Running 4 malicious behaviors:                 â”‚
â”‚                                                 â”‚
â”‚  1. ğŸ”´ C2 Beacon        (every 5 seconds)      â”‚
â”‚  2. ğŸ“¤ Data Exfiltration (every 15 seconds)    â”‚
â”‚  3. ğŸ¦  EICAR Upload     (every 30 seconds)     â”‚
â”‚  4. ğŸŒ DNS DGA Attack   (every 20 seconds)     â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        All traffic goes to Monitor (192.168.6.131)
                     â†“
              tcpdump captures it
                     â†“
              Zeek analyzes it
                     â†“
         Logs show malware patterns âœ…
```

---

## ğŸ”´ **The 4 Malware Behaviors**

### **1. C2 Beacon (Command & Control)**
**What it does:**
- Sends HTTP requests every **5 seconds**
- Pretends to be malware checking in with its controller
- Uses suspicious user-agent: `poc-beacon/1.0`

**Traffic pattern:**
```
Every 5 seconds:
  192.168.6.134 â†’ 192.168.6.131:8080
  GET /beacon HTTP/1.1
  User-Agent: poc-beacon/1.0
  X-Session-ID: random-uuid
```

---

### **2. Data Exfiltration (Stealing Data)**
**What it does:**
- Uploads fake "sensitive files" every **15 seconds**
- Simulates stealing credentials, documents, system info
- Uses HTTP POST to upload files

**Traffic pattern:**
```
Every 15 seconds:
  192.168.6.134 â†’ 192.168.6.131:8080
  POST /upload HTTP/1.1
  Content-Type: multipart/form-data
  File: sensitive_data.txt (200-500 bytes)
  X-Exfil-Session: session-12345
```

**Files it "steals" (fake data):**
- Credentials: `admin@company.local / P@ssw0rd123`
- Documents: `DOC-12345 - Confidential content`
- System Info: `Hostname, IP, processes`

---

### **3. EICAR Upload (Virus Test File)**
**What it does:**
- Uploads EICAR test file every **30 seconds**
- EICAR is a harmless test string that all antivirus detect
- Simulates uploading malware payload

**EICAR string:**
```
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
```

**Traffic pattern:**
```
Every 30 seconds:
  192.168.6.134 â†’ 192.168.6.131:8080
  POST /upload HTTP/1.1
  File: eicar.txt
  X-Malware-Test: EICAR
```

---

### **4. DNS DGA Attack (Domain Generation)**
**What it does:**
- Generates **50 random domains** every **20 seconds**
- Queries non-existent domains (NXDOMAIN responses)
- Simulates malware trying to find C2 server

**Traffic pattern:**
```
Every 20 seconds:
  50x DNS queries:
    akj3hd92kd.com     â†’ NXDOMAIN (doesn't exist)
    x8f3kd9sk2.net     â†’ NXDOMAIN
    malware-c2-1234.xyz â†’ NXDOMAIN
    botnet-5678.tk     â†’ NXDOMAIN
    evil-payload-90.ru â†’ NXDOMAIN
```

---

## ğŸ” **How to Find Malware in Zeek Logs**

### **Step 1: Start Malware Attacker**
```powershell
# From Windows PowerShell
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\attackers\malware_attacker
.\START_MALWARE_ATTACKER.bat
```

### **Step 2: Wait 1-2 Minutes**
```
Zeek needs time to:
  - Capture traffic (tcpdump)
  - Analyze PCAPs (monitor.sh)
  - Generate logs
```

### **Step 3: Check Zeek Logs**
```powershell
# View latest Zeek session
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\network
wsl docker exec network-monitor ls -lh /app/zeek_logs/
```

You'll see:
```
session_20251114_120000/
  â”œâ”€â”€ conn.log          â† Network connections
  â”œâ”€â”€ http.log          â† HTTP requests (C2 beacon, uploads)
  â”œâ”€â”€ dns.log           â† DNS queries (DGA attack)
  â”œâ”€â”€ files.log         â† File transfers (exfil, EICAR)
  â””â”€â”€ packet_filter.log â† Statistics
```

---

## ğŸ“Š **What to Look for in Each Log**

### **1. conn.log - Network Connections**
**Find malware:**
```bash
# High frequency connections from same IP
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && zeek-cut id.orig_h id.resp_h proto < conn.log | grep 192.168.6.134 | wc -l"
```

**What you'll see:**
```
Source IP: 192.168.6.134 (malware attacker)
Destination: 192.168.6.131:8080 (target)
Connection count: 50+ connections in 5 minutes
Pattern: Regular intervals (every 5, 15, 30 seconds)
```

**Detection signatures:**
- âœ… High connection frequency (>10 connections/min)
- âœ… Regular timing pattern (automated behavior)
- âœ… Always to same target IP:port

---

### **2. http.log - HTTP Requests**
**Find malware:**
```bash
# Look for suspicious User-Agent
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && zeek-cut id.orig_h user_agent uri < http.log | grep 192.168.6.134"
```

**What you'll see:**
```
192.168.6.134  poc-beacon/1.0  /beacon
192.168.6.134  curl/7.x.x      /upload
192.168.6.134  curl/7.x.x      /upload
192.168.6.134  curl/7.x.x      /upload
```

**Detection signatures:**
- âœ… Suspicious User-Agent: `poc-beacon/1.0`
- âœ… Repetitive POST to `/upload`
- âœ… GET to `/beacon` endpoint
- âœ… High request frequency

---

### **3. dns.log - DNS Queries**
**Find malware:**
```bash
# Count NXDOMAIN responses (failed DNS lookups)
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && zeek-cut query rcode < dns.log | grep NXDOMAIN | wc -l"
```

**What you'll see:**
```
Query: akj3hd92kd.com      â†’ NXDOMAIN
Query: x8f3kd9sk2.net      â†’ NXDOMAIN
Query: malware-c2-1234.xyz â†’ NXDOMAIN
Query: botnet-5678.tk      â†’ NXDOMAIN
Count: 150+ NXDOMAIN in 5 minutes
```

**Detection signatures:**
- âœ… High NXDOMAIN rate (>50/min)
- âœ… Random-looking domain names
- âœ… Suspicious TLDs (.xyz, .tk, .ru)
- âœ… Pattern: DGA (Domain Generation Algorithm)

---

### **4. files.log - File Transfers**
**Find malware:**
```bash
# Look for uploaded files
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && zeek-cut source tx_hosts filename < files.log"
```

**What you'll see:**
```
Source: HTTP
TX Host: 192.168.6.134
Files: eicar.txt, sensitive_data.txt
Size: 68-500 bytes
Frequency: Every 15-30 seconds
```

**Detection signatures:**
- âœ… Frequent file uploads
- âœ… EICAR signature detected
- âœ… Files named "sensitive_data", "eicar"
- âœ… Small file sizes (credentials/configs)

---

## ğŸ¯ **Quick Detection Commands**

### **Check if Malware is Active**
```bash
# 1. Count total connections from malware IP
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && grep 192.168.6.134 conn.log | wc -l"

# Expected: 20+ if malware is running
```

### **Find C2 Beacon Traffic**
```bash
# 2. Look for beacon user-agent
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && grep 'poc-beacon' http.log"

# Expected: Multiple entries with GET /beacon
```

### **Find DNS DGA Attack**
```bash
# 3. Count NXDOMAIN responses
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && grep NXDOMAIN dns.log | wc -l"

# Expected: 50+ if malware is running
```

### **Find File Exfiltration**
```bash
# 4. Look for uploads
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && grep 'POST' http.log | grep upload"

# Expected: Multiple POST /upload entries
```

### **Find EICAR Upload**
```bash
# 5. Look for EICAR file
wsl docker exec network-monitor bash -c "cd /app/zeek_logs/session_*/ && grep 'eicar' files.log"

# Expected: File transfers with eicar.txt
```

---

## ğŸ“ˆ **Malware Detection Thresholds**

### **Normal Device vs Malware**

| Metric | Normal Device | Malware Device | Detection |
|--------|--------------|----------------|-----------|
| **Connections/min** | 1-3 | 15-20 | âš ï¸ High frequency |
| **HTTP Requests** | Random | Regular interval | âš ï¸ Automated |
| **DNS NXDOMAIN** | 0-2 | 50+ | ğŸš¨ DGA attack |
| **File Uploads** | 0 | 3-4/min | ğŸš¨ Exfiltration |
| **User-Agent** | Normal browser | `poc-beacon/1.0` | ğŸš¨ Suspicious |
| **Endpoints** | Various | `/beacon`, `/upload` | ğŸš¨ C2 pattern |

---

## ğŸ”´ **Complete Detection Workflow**

```
Step 1: Start Malware Attacker
  â†“
Step 2: Wait 2 minutes (Zeek analysis)
  â†“
Step 3: Check latest session logs
  â†“
Step 4: Look for these patterns:
  
  âœ… conn.log: 192.168.6.134 has 20+ connections
  âœ… http.log: User-Agent contains "poc-beacon"
  âœ… http.log: Multiple POST to /upload
  âœ… dns.log: 50+ NXDOMAIN responses
  âœ… files.log: eicar.txt detected
  
  â†“
Step 5: Malware Confirmed! ğŸ¦ 
  
Detection Verdict:
  - C2 Beacon: DETECTED
  - Data Exfiltration: DETECTED
  - EICAR Upload: DETECTED
  - DNS DGA: DETECTED
  - Confidence: 95%+
  
  â†“
Step 6: Auto-isolate to honeypot
  (Dashboard can redirect to 172.18.0.2)
```

---

## ğŸ“ **Example: Real Zeek Log Entries**

### **conn.log (C2 Beacon)**
```
1731574887.042  CHhAvVGS1DHFjwGMf  192.168.6.134  51234  192.168.6.131  8080  tcp  http  0.5  187  318  S1
1731574892.103  DKxBvWHS2EIGkxHNg  192.168.6.134  51235  192.168.6.131  8080  tcp  http  0.5  187  318  S1
1731574897.201  ELyCwXIT3FJHlyIOh  192.168.6.134  51236  192.168.6.131  8080  tcp  http  0.5  187  318  S1
```
**Pattern:** Every 5 seconds, same source, same destination

---

### **http.log (C2 Beacon + Uploads)**
```
1731574887.042  CHhAvVGS1DHFjwMf  192.168.6.134  51234  192.168.6.131  8080  1  GET  192.168.6.131  /beacon  -  poc-beacon/1.0  -  200  OK
1731574900.105  DKxBvWHS2EIGkxHg  192.168.6.134  51237  192.168.6.131  8080  1  POST  192.168.6.131  /upload  -  curl/7.81.0  450  200  OK
1731574915.208  ELyCwXIT3FJHlyIh  192.168.6.134  51238  192.168.6.131  8080  1  POST  192.168.6.131  /upload  -  curl/7.81.0  320  200  OK
```
**Pattern:** GET /beacon + POST /upload, suspicious user-agents

---

### **dns.log (DGA Attack)**
```
1731574920.301  FMzDxYJU4GKIzmJi  192.168.6.134  53124  127.0.0.11  53  udp  12345  akj3hd92kd.com  1  C_INTERNET  1  A  3  NXDOMAIN  -  F
1731574920.502  GMaEyZKV5HLJanKj  192.168.6.134  53125  127.0.0.11  53  udp  12346  x8f3kd9sk2.net  1  C_INTERNET  1  A  3  NXDOMAIN  -  F
1731574920.703  HNbFzALW6IMKboLk  192.168.6.134  53126  127.0.0.11  53  udp  12347  malware-c2-1234.xyz  1  C_INTERNET  1  A  3  NXDOMAIN  -  F
```
**Pattern:** Rapid NXDOMAIN responses, random domains

---

### **files.log (EICAR Upload)**
```
1731574930.801  IOcGaBMX7JNLcpMl  HTTP  0  192.168.6.134  192.168.6.131  192.168.6.131  -  eicar.txt  -  application/octet-stream  68  -  -  -  F  F
1731574960.905  JPdHbCNY8KOMdqNm  HTTP  0  192.168.6.134  192.168.6.131  192.168.6.131  -  sensitive_data.txt  -  text/plain  320  -  -  -  F  F
```
**Pattern:** File uploads, EICAR signature, sensitive filenames

---

## ğŸ¯ **AI Agent Detection Logic**

**How the AI Agent should detect malware:**

```python
# Pseudo-code for malware detection

def detect_malware(zeek_logs):
    score = 0
    
    # 1. Check C2 Beacon
    if user_agent_contains("poc-beacon"):
        score += 25
        
    if http_requests_to("/beacon") > 5:
        score += 25
    
    # 2. Check Data Exfiltration
    if post_requests_to("/upload") > 3:
        score += 20
        
    if files_uploaded > 2:
        score += 20
    
    # 3. Check DNS DGA
    if nxdomain_count > 50:
        score += 30
    
    # 4. Check EICAR
    if files_contain("eicar"):
        score += 40
    
    # Final verdict
    if score >= 85:
        return "CRITICAL - Malware Detected"
    elif score >= 50:
        return "WARNING - Suspicious Activity"
    else:
        return "NORMAL"
```

**Expected scores:**
- Malware Attacker: **120+ points** â†’ CRITICAL
- Normal Device: **0-10 points** â†’ NORMAL
- SSH Attacker: **25-40 points** â†’ WARNING

---

## ğŸ›¡ï¸ **How to Stop Malware Attacker**

```powershell
# Stop the attacker
cd E:\Malware_detection_using_Aiagent\Network_Security_poc\attackers\malware_attacker
.\STOP_MALWARE_ATTACKER.bat

# This will:
# 1. Stop the container
# 2. Clean up iptables rules
# 3. Remove malware from network
```

---

## ğŸ“Š **Summary**

**When you run malware attacker:**
1. âœ… Container starts with IP 192.168.6.134
2. âœ… Runs 4 malware behaviors in parallel
3. âœ… Traffic flows to monitor (192.168.6.131)
4. âœ… tcpdump captures everything
5. âœ… Zeek analyzes and creates logs
6. âœ… Logs show clear malware patterns

**How to confirm it's working:**
1. Check `conn.log` â†’ High connection count
2. Check `http.log` â†’ `poc-beacon` user-agent
3. Check `dns.log` â†’ Many NXDOMAIN
4. Check `files.log` â†’ EICAR uploads

**Detection is easy because:**
- ğŸ”´ Malware has obvious patterns
- ğŸ”´ Regular timing (automated)
- ğŸ”´ Suspicious strings (`poc-beacon`, `eicar`)
- ğŸ”´ High volume (50+ DNS, 20+ HTTP)

Your AI agent can detect this with **95%+ confidence**! ğŸ¯
